<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>個人化互動行事曆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root {
            --bg-main: #F8FAFC;
            --accent-blue: #A3C4F3;
            --accent-pink: #FDE2E4;
            --accent-green: #CFEFDF;
            --text-dark: #1E293B;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-main); color: var(--text-dark); -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="date"], input[type="time"], textarea, input[type="text"] { 
            background-color: #F1F5F9; 
            border: none; 
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
        }
        input:focus, textarea:focus { ring: 2px solid var(--accent-blue); }
        .layer-dot { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-layer { opacity: 0.15; filter: grayscale(1); transform: scale(0.85); }
        .modal-bg { background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32 relative">

    <!-- 頂部 Header -->
    <header id="app-header" class="p-6 bg-white/80 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-100"></header>

    <!-- 內容區 -->
    <main id="app-body" class="p-5"></main>

    <!-- 底部功能列 -->
    <div id="footer-nav" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-[360px] bg-slate-900 shadow-2xl text-white p-3 rounded-[32px] flex justify-between items-center z-50"></div>

    <!-- 彈窗容器 -->
    <div id="modal-layer" class="z-[60]"></div>

    <script>
        // --- 1. 核心資料與狀態 ---
        let app = {
            currentDate: new Date(),
            view: 'month', // 'month', 'day', 'items'
            categories: [
                { id: 'work', name: '工作項目', color: '#A3C4F3', light: '#EBF2FF' },
                { id: 'draw', name: '畫畫創作', color: '#FDE2E4', light: '#FFF5F6' },
                { id: 'life', name: '生活日常', color: '#CFEFDF', light: '#F0FBF5' }
            ],
            visibleLayers: ['work', 'draw', 'life'],
            events: [
                { id: 'e1', title: '點擊我編輯', description: '可以寫下詳細內容喔！', type: 'life', date: getTodayStr(), hasTime: false, time: '12:00', isRecurring: false, repeatDays: [], hasEndDate: false, endDate: '' }
            ],
            exceptions: [], // 被刪除的單次重複行程
            showDatePicker: false
        };

        // --- 2. 輔助工具 ---
        function getTodayStr() { return new Date().toISOString().split('T')[0]; }
        function formatDate(d) {
            const date = new Date(d);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        function getLightColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r},${g},${b}, 0.15)`;
        }

        // --- 3. 核心邏輯：行程篩選 ---
        function getEventsOnDate(date) {
            const dateStr = formatDate(date);
            const dayOfWeek = date.getDay();
            return app.events.filter(ev => {
                if (!app.visibleLayers.includes(ev.type)) return false;
                // 檢查例外
                if (app.exceptions.some(ex => ex.id === ev.id && ex.date === dateStr)) return false;

                if (ev.isRecurring) {
                    const start = new Date(ev.date);
                    const target = new Date(dateStr);
                    if (target < start) return false;
                    if (ev.hasEndDate && ev.endDate && target > new Date(ev.endDate)) return false;
                    return ev.repeatDays.includes(dayOfWeek);
                }
                return ev.date === dateStr;
            }).sort((a, b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
        }

        // --- 4. 渲染函數 ---
        function init() { render(); }

        function render() {
            renderHeader();
            renderBody();
            renderFooter();
            lucide.createIcons();
        }

        function renderHeader() {
            const el = document.getElementById('app-header');
            const monthLabel = MONTHS[app.currentDate.getMonth()];
            const yearLabel = app.currentDate.getFullYear();

            el.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2 cursor-pointer active:scale-95" onclick="app.showDatePicker = !app.showDatePicker; render()">
                        <h1 class="text-2xl font-black tracking-tight">${yearLabel}年 ${monthLabel}</h1>
                        <i data-lucide="chevron-down" class="text-slate-300 w-5 h-5"></i>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-2xl">
                        <button onclick="setView('month')" class="p-2.5 rounded-xl ${app.view === 'month' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                        <button onclick="setView('day')" class="p-2.5 rounded-xl ${app.view === 'day' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}"><i data-lucide="calendar-days" class="w-4 h-4"></i></button>
                        <button onclick="setView('items')" class="p-2.5 rounded-xl ${app.view === 'items' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}"><i data-lucide="layers" class="w-4 h-4"></i></button>
                    </div>
                </div>

                ${app.showDatePicker ? `
                    <div class="absolute top-full left-6 right-6 mt-2 bg-white border border-slate-100 shadow-2xl rounded-3xl p-6 z-50 animate-fade-in">
                        <div class="flex justify-between items-center mb-4 font-black">
                            <button onclick="moveYear(-1)" class="p-2 bg-slate-50 rounded-lg"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <span>${yearLabel}</span>
                            <button onclick="moveYear(1)" class="p-2 bg-slate-50 rounded-lg"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${MONTHS.map((m, i) => `<button onclick="setMonth(${i})" class="py-3 text-xs font-bold rounded-xl ${app.currentDate.getMonth() === i ? 'bg-blue-600 text-white' : 'bg-slate-50'}">${m}</button>`).join('')}
                        </div>
                    </div>
                ` : ''}

                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button onclick="navigate(-1)" class="p-3 bg-slate-50 rounded-xl text-slate-400"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <button onclick="goToday()" class="px-6 py-3 bg-slate-50 rounded-xl text-[10px] font-black tracking-widest text-slate-600">今天</button>
                        <button onclick="navigate(1)" class="p-3 bg-slate-50 rounded-xl text-slate-400"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex -space-x-3">
                        ${app.categories.map(c => `<div onclick="toggleLayer('${c.id}')" class="w-9 h-9 rounded-full border-2 border-white layer-dot shadow-sm ${app.visibleLayers.includes(c.id) ? 'z-10' : 'hidden-layer'}" style="background-color: ${c.color}"></div>`).join('')}
                    </div>
                </div>
            `;
        }

        const MONTHS = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        const WEEKDAYS = ['日', '一', '二', '三', '四', '五', '六'];

        function renderBody() {
            const el = document.getElementById('app-body');
            el.innerHTML = '';
            if (app.view === 'month') renderMonth(el);
            else if (app.view === 'day') renderDay(el);
            else renderItems(el);
        }

        function renderMonth(container) {
            const d = app.currentDate;
            const start = new Date(d.getFullYear(), d.getMonth(), 1).getDay();
            const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
            
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-7 gap-px bg-slate-100 rounded-[32px] overflow-hidden border border-slate-50 shadow-sm animate-fade-in";
            
            WEEKDAYS.forEach(w => grid.innerHTML += `<div class="bg-white p-3 text-center text-[10px] font-bold text-slate-400">${w}</div>`);
            
            for (let i = 0; i < start + daysInMonth; i++) {
                const cell = document.createElement('div');
                cell.className = "bg-white min-h-[105px] p-1 border-t border-slate-50 transition-colors hover:bg-blue-50/20 cursor-pointer";
                
                if (i >= start) {
                    const dayNum = i - start + 1;
                    const dateObj = new Date(d.getFullYear(), d.getMonth(), dayNum);
                    const isToday = formatDate(dateObj) === formatDate(new Date());
                    const isSelected = formatDate(dateObj) === formatDate(app.currentDate);
                    
                    cell.onclick = () => { app.currentDate = dateObj; setView('day'); };
                    cell.innerHTML = `<div class="text-xs mb-1 flex justify-center items-center w-7 h-7 rounded-full mx-auto font-black ${isToday ? 'bg-blue-600 text-white' : isSelected ? 'bg-blue-100 text-blue-600' : 'text-slate-400'}">${dayNum}</div>`;
                    
                    const evs = getEventsOnDate(dateObj);
                    evs.slice(0, 3).forEach(ev => {
                        const c = app.categories.find(cat => cat.id === ev.type) || { color: '#CCC' };
                        cell.innerHTML += `<div onclick="event.stopPropagation(); showDetail('${ev.id}', '${formatDate(dateObj)}')" class="text-[9px] px-2 py-0.5 rounded-md border mb-0.5 truncate font-bold" style="background-color: ${getLightColor(c.color)}; border-color: ${c.color}">${ev.title}</div>`;
                    });
                    if (evs.length > 3) cell.innerHTML += `<div class="text-[9px] text-center text-slate-300">+${evs.length - 3}</div>`;
                } else {
                    cell.className = "bg-slate-50/50 min-h-[105px]";
                }
                grid.appendChild(cell);
            }
            container.appendChild(grid);
        }

        function renderDay(container) {
            const evs = getEventsOnDate(app.currentDate);
            container.innerHTML = `
                <div class="bg-white rounded-[40px] p-8 shadow-sm border border-slate-50 min-h-[500px] animate-fade-in">
                    <div class="flex items-center gap-6 mb-12">
                        <div class="bg-blue-600 text-white w-16 h-16 rounded-[24px] flex flex-col items-center justify-center shadow-lg">
                            <span class="text-[10px] font-black">${WEEKDAYS[app.currentDate.getDay()]}</span>
                            <span class="text-2xl font-black">${app.currentDate.getDate()}</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-black tracking-tight">${app.currentDate.getFullYear()}年 ${app.currentDate.getMonth()+1}月</h2>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">今日有 ${evs.length} 項行程</p>
                        </div>
                    </div>
                    <div class="space-y-6 relative">
                        <div class="absolute left-10 top-0 bottom-0 w-px bg-slate-50"></div>
                        ${evs.length ? evs.map(ev => {
                            const c = app.categories.find(cat => cat.id === ev.type) || { color: '#CCC' };
                            return `
                                <div onclick="showDetail('${ev.id}', '${formatDate(app.currentDate)}')" class="flex items-center gap-8 group cursor-pointer">
                                    <div class="text-[11px] font-black text-slate-300 w-12 text-right">${ev.hasTime ? ev.time : '全天'}</div>
                                    <div class="flex-1 p-6 rounded-[28px] border transition-all hover:shadow-md hover:-translate-y-1" style="background-color: ${getLightColor(c.color)}; border-color: ${c.color}">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-[9px] font-black text-slate-400 uppercase block mb-1">${c.name}</span>
                                                <span class="font-black text-slate-700 text-lg">${ev.title}</span>
                                                ${ev.description ? `<p class="text-xs text-slate-400 mt-2 line-clamp-2">${ev.description}</p>` : ''}
                                            </div>
                                            <i data-lucide="info" class="text-slate-300"></i>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : `<div class="py-32 text-center opacity-10 flex flex-col items-center"><i data-lucide="calendar" class="w-20 h-20"></i><p class="mt-4 font-black">今日無計畫</p></div>`}
                    </div>
                </div>
            `;
        }

        function renderItems(container) {
            container.innerHTML = `<button onclick="showCategoryModal()" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-[32px] text-slate-400 font-black text-sm flex items-center justify-center gap-3 hover:bg-slate-50 mb-6 transition-all"><i data-lucide="plus" class="w-5 h-5"></i> 新增項目類別</button>`;
            app.categories.forEach((c, idx) => {
                const evs = app.events.filter(e => e.type === c.id);
                container.innerHTML += `
                    <div class="bg-white rounded-[32px] p-8 shadow-sm border border-slate-50 mb-6 animate-fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-6 h-6 rounded-full shadow-inner" style="background-color: ${c.color}"></div>
                                <div>
                                    <h3 class="font-black text-lg flex items-center gap-2">${c.name} 
                                        <i data-lucide="edit-3" onclick="showCategoryModal('${c.id}')" class="w-3.5 h-3.5 text-slate-300 cursor-pointer"></i>
                                        <i data-lucide="trash-2" onclick="deleteCategory('${c.id}')" class="w-3.5 h-3.5 text-slate-300 cursor-pointer"></i>
                                    </h3>
                                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${evs.length} 項計畫</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="addEventInCat('${c.id}')" class="p-3 bg-blue-50 text-blue-600 rounded-2xl hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                <button onclick="toggleLayer('${c.id}')" class="px-4 py-2 rounded-2xl text-[10px] font-black ${app.visibleLayers.includes(c.id) ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-400'}">${app.visibleLayers.includes(c.id) ? '顯示中' : '隱藏中'}</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${evs.map(ev => `<div onclick="showDetail('${ev.id}', '${ev.date}')" class="p-4 bg-slate-50 rounded-2xl text-sm font-bold text-slate-600 flex justify-between items-center cursor-pointer hover:bg-white border border-transparent hover:border-slate-100 transition-all"><span>${ev.title}</span><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i></div>`).join('')}
                        </div>
                    </div>
                `;
            });
        }

        function renderFooter() {
            const el = document.getElementById('footer-nav');
            el.innerHTML = `
                <div class="flex flex-col pl-6">
                    <span class="text-[10px] text-slate-500 font-black uppercase">選定日期</span>
                    <span class="text-sm font-black">${formatDate(app.currentDate)}</span>
                </div>
                <button onclick="showEventModal('add')" class="bg-blue-600 w-14 h-14 rounded-[24px] flex items-center justify-center shadow-xl shadow-blue-500/20 active:scale-95 transition-all"><i data-lucide="plus" class="w-7 h-7"></i></button>
            `;
        }

        // --- 5. 互動功能 ---
        function setView(v) { app.view = v; render(); }
        function goToday() { app.currentDate = new Date(); render(); }
        function navigate(dir) {
            const d = app.currentDate;
            if (app.view === 'month') app.currentDate = new Date(d.getFullYear(), d.getMonth() + dir, 1);
            else app.currentDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() + dir);
            render();
        }
        function moveYear(dir) { app.currentDate.setFullYear(app.currentDate.getFullYear() + dir); render(); }
        function setMonth(m) { app.currentDate.setMonth(m); app.showDatePicker = false; render(); }
        function toggleLayer(id) {
            if (app.visibleLayers.includes(id)) app.visibleLayers = app.visibleLayers.filter(i => i !== id);
            else app.visibleLayers.push(id);
            render();
        }

        // --- 6. 彈窗邏輯 (Vanilla JS) ---
        function closeModals() { document.getElementById('modal-layer').innerHTML = ''; }

        function showDetail(id, dateStr) {
            const ev = app.events.find(e => e.id === id);
            if (!ev) return;
            const c = app.categories.find(cat => cat.id === ev.type) || { color: '#CCC' };
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 flex items-center justify-center p-6 modal-bg animate-fade-in";
            modal.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl">
                    <div class="h-32 p-10 flex items-end relative" style="background-color: ${c.color}">
                        <button onclick="closeModals()" class="absolute top-8 right-8 p-2.5 bg-white/20 hover:bg-white/40 rounded-full text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                        <h2 class="text-2xl font-black text-white drop-shadow-md">${ev.title}</h2>
                    </div>
                    <div class="p-8 space-y-6">
                        <div class="flex gap-4"><div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-blue-500"><i data-lucide="calendar"></i></div><div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">日期時間</p><p class="font-black text-slate-700">${dateStr} ${ev.hasTime ? ev.time : '(全天)'}</p></div></div>
                        ${ev.description ? `<div class="flex gap-4"><div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-orange-400"><i data-lucide="file-text"></i></div><div class="flex-1"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">備註內容</p><p class="text-sm font-medium text-slate-600 leading-relaxed">${ev.description}</p></div></div>` : ''}
                        <div class="pt-4 flex flex-col gap-3">
                            <button onclick="showEventModal('edit', '${ev.id}', '${dateStr}')" class="w-full bg-blue-600 text-white py-4 rounded-[22px] font-black text-sm flex items-center justify-center gap-2"><i data-lucide="edit-3" class="w-4 h-4"></i> 編輯行程內容</button>
                            <button onclick="deleteEvent('${ev.id}')" class="w-full bg-red-50 text-red-500 py-4 rounded-[22px] font-black text-sm">刪除此計畫</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-layer').appendChild(modal);
            lucide.createIcons();
        }

        let tempEvent = {};

        function showEventModal(mode, id = null, dateStr = null) {
            closeModals();
            if (mode === 'edit') {
                const original = app.events.find(e => e.id === id);
                tempEvent = { ...original, date: dateStr || original.date };
            } else {
                tempEvent = { id: 'e'+Date.now(), title: '', description: '', type: app.categories[0].id, date: dateStr || formatDate(app.currentDate), hasTime: false, time: '12:00', isRecurring: false, repeatDays: [], hasEndDate: false, endDate: '' };
            }
            renderEventForm(mode);
        }

        function addEventInCat(catId) { showEventModal('add', null, null); tempEvent.type = catId; renderEventForm('add'); }

        function renderEventForm(mode) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 flex items-end sm:items-center justify-center modal-bg animate-fade-in";
            modal.innerHTML = `
                <div class="bg-white w-full max-w-md rounded-t-[48px] sm:rounded-[48px] p-10 shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-black text-slate-800">${mode === 'add' ? '規劃行程' : '修改計畫'}</h2>
                        <button onclick="closeModals()" class="p-4 bg-slate-100 rounded-2xl text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="space-y-6">
                        ${mode === 'edit' && tempEvent.isRecurring ? `
                            <div class="flex p-1 bg-slate-100 rounded-2xl mb-4">
                                <button onclick="setEditScope('series')" id="btn-series" class="flex-1 py-3 text-xs font-black rounded-xl bg-white shadow text-blue-600">修改系列</button>
                                <button onclick="setEditScope('single')" id="btn-single" class="flex-1 py-3 text-xs font-black rounded-xl text-slate-400">僅此一次</button>
                            </div>
                        ` : ''}
                        <div><label class="text-[10px] font-black text-slate-400 block mb-2 tracking-widest uppercase">設定日期</label><input type="date" value="${tempEvent.date}" onchange="tempEvent.date=this.value"></div>
                        <div><label class="text-[10px] font-black text-slate-400 block mb-2 tracking-widest uppercase">行程標題</label><input type="text" value="${tempEvent.title}" oninput="tempEvent.title=this.value" placeholder="要做什麼呢？"></div>
                        <div><label class="text-[10px] font-black text-slate-400 block mb-2 tracking-widest uppercase">備註說明 (選填)</label><textarea oninput="tempEvent.description=this.value" rows="3" placeholder="補充細節...">${tempEvent.description}</textarea></div>
                        
                        <div><label class="text-[10px] font-black text-slate-400 block mb-3 tracking-widest uppercase">項目類別</label>
                            <div class="grid grid-cols-2 gap-3">
                                ${app.categories.map(c => `<button onclick="setFormType('${c.id}')" class="flex items-center gap-4 px-5 py-3 rounded-2xl text-sm font-black border-2 ${tempEvent.type === c.id ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white border-slate-100 text-slate-400'}"><div class="w-3 h-3 rounded-full" style="background-color: ${c.color}"></div>${c.name}</button>`).join('')}
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-6 bg-slate-50 rounded-[32px]">
                            <div class="flex items-center gap-4"><i data-lucide="clock" class="text-blue-500 w-5 h-5"></i><div class="font-black text-sm text-slate-700">設定具體時間</div></div>
                            <button onclick="toggleFormTime()" class="w-14 h-7 rounded-full transition-all relative ${tempEvent.hasTime ? 'bg-blue-600' : 'bg-slate-200'}"><div class="absolute top-1 w-5 h-5 bg-white rounded-full transition-all ${tempEvent.hasTime ? 'left-8' : 'left-1'}"></div></button>
                        </div>
                        ${tempEvent.hasTime ? `<input type="time" value="${tempEvent.time}" onchange="tempEvent.time=this.value" class="text-center text-2xl font-black">` : ''}

                        <div class="flex items-center justify-between p-6 bg-slate-50 rounded-[32px]">
                            <div class="flex items-center gap-4"><i data-lucide="check-circle" class="text-green-500 w-5 h-5"></i><div class="font-black text-sm text-slate-700">每週重複計畫</div></div>
                            <button onclick="toggleFormRecur()" class="w-14 h-7 rounded-full transition-all relative ${tempEvent.isRecurring ? 'bg-green-500' : 'bg-slate-200'}"><div class="absolute top-1 w-5 h-5 bg-white rounded-full transition-all ${tempEvent.isRecurring ? 'left-8' : 'left-1'}"></div></button>
                        </div>
                        ${tempEvent.isRecurring ? `
                            <div class="space-y-4">
                                <div class="flex justify-between gap-2">
                                    ${WEEKDAYS.map((w, i) => `<button onclick="toggleRepeatDay(${i})" class="flex-1 aspect-square rounded-[18px] text-[10px] font-black ${tempEvent.repeatDays.includes(i) ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}">${w}</button>`).join('')}
                                </div>
                                <div class="p-6 bg-blue-50/30 rounded-[32px] border border-blue-100/50">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3"><i data-lucide="calendar-range" class="text-blue-500"></i><span class="font-black text-sm">設定截止日</span></div>
                                        <button onclick="toggleFormEndDate()" class="w-12 h-6 rounded-full transition-all relative ${tempEvent.hasEndDate ? 'bg-blue-500' : 'bg-slate-200'}"><div class="absolute top-0.5 w-5 h-5 bg-white rounded-full ${tempEvent.hasEndDate ? 'left-6.5' : 'left-0.5'}"></div></button>
                                    </div>
                                    ${tempEvent.hasEndDate ? `<input type="date" value="${tempEvent.endDate}" onchange="tempEvent.endDate=this.value" class="bg-white">` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="saveEvent()" class="w-full bg-blue-600 text-white py-6 rounded-[28px] font-black text-xl shadow-xl active:scale-95 transition-all mt-4 hover:bg-blue-700">確定儲存計畫</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-layer').innerHTML = '';
            document.getElementById('modal-layer').appendChild(modal);
            lucide.createIcons();
        }

        let currentScope = 'series';
        function setEditScope(s) {
            currentScope = s;
            document.getElementById('btn-series').className = `flex-1 py-3 text-xs font-black rounded-xl ${s === 'series' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`;
            document.getElementById('btn-single').className = `flex-1 py-3 text-xs font-black rounded-xl ${s === 'single' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`;
        }
        function setFormType(t) { tempEvent.type = t; renderEventForm(tempEvent.id ? 'edit' : 'add'); }
        function toggleFormTime() { tempEvent.hasTime = !tempEvent.hasTime; renderEventForm(tempEvent.id ? 'edit' : 'add'); }
        function toggleFormRecur() { tempEvent.isRecurring = !tempEvent.isRecurring; renderEventForm(tempEvent.id ? 'edit' : 'add'); }
        function toggleFormEndDate() { tempEvent.hasEndDate = !tempEvent.hasEndDate; renderEventForm(tempEvent.id ? 'edit' : 'add'); }
        function toggleRepeatDay(i) {
            if (tempEvent.repeatDays.includes(i)) tempEvent.repeatDays = tempEvent.repeatDays.filter(d => d !== i);
            else tempEvent.repeatDays.push(i);
            renderEventForm(tempEvent.id ? 'edit' : 'add');
        }

        function saveEvent() {
            if (!tempEvent.title) return;
            // 處理「僅此一次」的邏輯
            if (currentScope === 'single' && tempEvent.isRecurring) {
                app.exceptions.push({ id: tempEvent.id, date: tempEvent.date });
                const singleCopy = { ...tempEvent, id: 'e'+Date.now(), isRecurring: false, repeatDays: [] };
                app.events.push(singleCopy);
            } else {
                app.events = app.events.filter(e => e.id !== tempEvent.id);
                app.events.push(tempEvent);
            }
            closeModals();
            render();
        }

        function deleteEvent(id) { app.events = app.events.filter(e => e.id !== id); closeModals(); render(); }

        // --- 7. 項目管理彈窗 ---
        let tempCat = {};
        function showCategoryModal(id = null) {
            if (id) {
                const original = app.categories.find(c => c.id === id);
                tempCat = { ...original };
            } else {
                tempCat = { id: 'c'+Date.now(), name: '', color: '#A3C4F3' };
            }
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 flex items-center justify-center p-6 modal-bg animate-fade-in";
            modal.innerHTML = `
                <div class="bg-white w-full max-w-sm rounded-[40px] p-10 shadow-2xl">
                    <h2 class="text-2xl font-black mb-8">${id ? '編輯項目分類' : '建立新分類'}</h2>
                    <div class="space-y-6">
                        <div><label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">類別名稱</label><input type="text" value="${tempCat.name}" id="cat-name-in" placeholder="生活、工作..."></div>
                        <div><label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">代表色</label>
                            <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl">
                                <input type="color" value="${tempCat.color}" id="cat-color-in" class="w-12 h-12 bg-transparent cursor-pointer border-none">
                                <span class="text-sm font-mono text-slate-400 uppercase">自定義色碼</span>
                            </div>
                        </div>
                        <div class="pt-4 flex gap-3">
                            <button onclick="closeModals()" class="flex-1 py-4 bg-slate-100 text-slate-400 font-black rounded-2xl">取消</button>
                            <button onclick="saveCategory()" class="flex-1 py-4 bg-slate-800 text-white font-black rounded-2xl shadow-lg">儲存變更</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-layer').innerHTML = '';
            document.getElementById('modal-layer').appendChild(modal);
        }

        function saveCategory() {
            const name = document.getElementById('cat-name-in').value;
            const color = document.getElementById('cat-color-in').value;
            if (!name) return;
            const cat = { id: tempCat.id, name, color };
            app.categories = app.categories.filter(c => c.id !== cat.id);
            app.categories.push(cat);
            if (!app.visibleLayers.includes(cat.id)) app.visibleLayers.push(cat.id);
            closeModals();
            render();
        }

        function deleteCategory(id) {
            if (app.categories.length <= 1) return;
            app.categories = app.categories.filter(c => c.id !== id);
            app.events = app.events.filter(e => e.type !== id);
            render();
        }

        function moveCat(idx, dir) {
            const target = idx + dir;
            if (target < 0 || target >= app.categories.length) return;
            [app.categories[idx], app.categories[target]] = [app.categories[target], app.categories[idx]];
            render();
        }

        window.onload = init;
    </script>
</body>
</html>

