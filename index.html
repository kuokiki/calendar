<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的全功能日曆</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 輔助圖示組件
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // 輔助函數
        const getLightColor = (hex) => {
            if (!hex.startsWith('#')) return '#F3F4F6';
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const lr = Math.min(255, Math.floor(r + (255 - r) * 0.85));
            const lg = Math.min(255, Math.floor(g + (255 - g) * 0.85));
            const lb = Math.min(255, Math.floor(b + (255 - b) * 0.85));
            return `rgb(${lr}, ${lg}, ${lb})`;
        };

        const WEEKDAYS = ['日', '一', '二', '三', '四', '五', '六'];
        const MONTHS = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

        const App = () => {
            // --- 狀態管理 ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('month');
            const [categories, setCategories] = useState([
                { id: 'work', name: '工作項目', color: '#A3C4F3', lightColor: '#EBF2FF' },
                { id: 'draw', name: '畫畫創作', color: '#FDE2E4', lightColor: '#FFF5F6' },
                { id: 'life', name: '生活日常', color: '#CFEFDF', lightColor: '#F0FBF5' },
            ]);
            const [visibleLayers, setVisibleLayers] = useState(['work', 'draw', 'life']);
            const [events, setEvents] = useState([]);
            const [exceptions, setExceptions] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('add');
            const [selectedDetail, setSelectedDetail] = useState(null);
            const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
            const [formEvent, setFormEvent] = useState({ title: '', type: 'work', date: '', isRecurring: false, repeatDays: [] });
            const [catForm, setCatForm] = useState({ name: '', color: '#A3C4F3' });

            useEffect(() => { lucide.createIcons(); }, [view, isModalOpen, selectedDetail]);

            const formatKey = (date) => {
                if (!date) return "";
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            const getEventsForDate = (date) => {
                if (!date) return [];
                const dateStr = formatKey(date);
                const dayOfWeek = date.getDay();
                return events.filter(ev => {
                    if (!visibleLayers.includes(ev.type)) return false;
                    if (ev.isRecurring) {
                        return new Date(dateStr) >= new Date(ev.startDate) && ev.repeatDays.includes(dayOfWeek);
                    }
                    return ev.date === dateStr;
                });
            };

            const handleSaveEvent = () => {
                if (!formEvent.title) return;
                const newEvent = { ...formEvent, id: Math.random().toString(36).substr(2, 9), startDate: formEvent.date };
                setEvents([...events, newEvent]);
                setIsModalOpen(false);
            };

            // --- 視圖組件 (MonthView 簡化版) ---
            const MonthView = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const numDays = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(null);
                for (let i = 1; i <= numDays; i++) days.push(new Date(year, month, i));

                return (
                    <div className="grid grid-cols-7 gap-px bg-gray-200 rounded-3xl overflow-hidden shadow-sm animate-in">
                        {WEEKDAYS.map(d => <div key={d} className="bg-white p-2 text-center text-[10px] font-bold text-gray-400">{d}</div>)}
                        {days.map((day, i) => (
                            <div key={i} onClick={() => day && (setCurrentDate(day), setView('day'))} className="bg-white min-h-[80px] p-1 border-t border-gray-50">
                                {day && <div className={`text-xs w-6 h-6 flex items-center justify-center rounded-full mx-auto ${formatKey(day) === formatKey(new Date()) ? 'bg-blue-600 text-white' : 'text-gray-700'}`}>{day.getDate()}</div>}
                                <div className="mt-1 space-y-1">
                                    {day && getEventsForDate(day).slice(0, 2).map(ev => (
                                        <div key={ev.id} className="text-[8px] truncate px-1 rounded" style={{backgroundColor: categories.find(c => c.id === ev.type)?.lightColor}}>{ev.title}</div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative">
                    <header className="p-6 bg-white border-b sticky top-0 z-10 flex justify-between items-center">
                        <h1 className="text-xl font-black">{currentDate.getFullYear()}年 {MONTHS[currentDate.getMonth()]}</h1>
                        <div className="flex gap-2 bg-gray-100 p-1 rounded-xl">
                            <button onClick={() => setView('month')} className={`p-2 rounded-lg ${view === 'month' ? 'bg-white shadow' : ''}`}><Icon name="calendar" size={16}/></button>
                            <button onClick={() => setView('items')} className={`p-2 rounded-lg ${view === 'items' ? 'bg-white shadow' : ''}`}><Icon name="layers" size={16}/></button>
                        </div>
                    </header>

                    <main className="p-4">
                        {view === 'month' ? <MonthView /> : <div className="text-center py-20 text-gray-400">其他視圖載入中...</div>}
                    </main>

                    {/* 懸浮按鈕 */}
                    <button 
                        onClick={() => { setFormEvent({ title: '', type: 'work', date: formatKey(currentDate), isRecurring: false, repeatDays: [] }); setIsModalOpen(true); }}
                        className="fixed bottom-8 right-8 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center animate-bounce"
                    >
                        <Icon name="plus" size={28} />
                    </button>

                    {/* 新增視窗 (簡化) */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end">
                            <div className="bg-white w-full rounded-t-[40px] p-8 animate-in">
                                <h2 className="text-xl font-black mb-4">新增行程</h2>
                                <input type="text" placeholder="行程名稱" className="w-full bg-gray-100 p-4 rounded-2xl mb-4 outline-none" onChange={e => setFormEvent({...formEvent, title: e.target.value})} />
                                <input type="date" className="w-full bg-gray-100 p-4 rounded-2xl mb-6" value={formEvent.date} onChange={e => setFormEvent({...formEvent, date: e.target.value})} />
                                <button onClick={handleSaveEvent} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">儲存計畫</button>
                                <button onClick={() => setIsModalOpen(false)} className="w-full py-4 text-gray-400">取消</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
