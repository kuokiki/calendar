<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極簡風格行事曆 - 專業版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --accent-blue: #A3C4F3; --text-dark: #1E293B; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F9FBFD; color: var(--text-dark); -webkit-tap-highlight-color: transparent; }
        input[type="date"], input[type="time"], input[type="text"], textarea { background-color: #F1F5F9; border: none; border-radius: 12px; padding: 12px 16px; width: 100%; outline: none; font-weight: 500; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        .fade-in { animation: fadeIn 0.25s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .day-cell { min-height: 105px; transition: all 0.2s; cursor: pointer; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32 relative shadow-2xl bg-white">

    <header id="app-header" class="p-6 bg-white/90 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-100"></header>
    <main id="app-main" class="p-5"></main>
    <div id="app-footer" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-[360px] bg-slate-900 shadow-2xl text-white p-3 rounded-[32px] flex justify-between items-center z-50"></div>
    <div id="modal-container"></div>

    <script>
        // --- 圖示庫 ---
        const SVG = {
            calendar: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
            days: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4M16 2v4M3 10h18M21 4H3v16h18V4zM8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>',
            layers: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.1 6.3a2 2 0 0 0 0 3.38L11.17 14a2 2 0 0 0 1.66 0l9.07-4.32a2 2 0 0 0 0-3.38Z"/><path d="m2.1 14.74 9.07 4.32a2 2 0 0 0 1.66 0l9.07-4.32"/><path d="m2.1 10.58 9.07 4.32a2 2 0 0 0 1.66 0l9.07-4.32"/></svg>',
            plus: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5v14"/></svg>',
            x: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>',
            trash: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/></svg>',
            check: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>'
        };

        // --- 狀態管理 ---
        let state = {
            currentDate: new Date(),
            view: 'month',
            categories: JSON.parse(localStorage.getItem('cats')) || [
                { id: 'c1', name: '工作項目', color: '#A3C4F3' },
                { id: 'c2', name: '畫畫創作', color: '#EC4899' },
                { id: 'c3', name: '生活日常', color: '#CFEFDF' }
            ],
            events: JSON.parse(localStorage.getItem('evs')) || [],
            exceptions: JSON.parse(localStorage.getItem('exs')) || [], // 存放單次修改的日期排除
            tempEv: {},
            editScope: 'series' // series or single
        };

        const save = () => {
            localStorage.setItem('cats', JSON.stringify(state.categories));
            localStorage.setItem('evs', JSON.stringify(state.events));
            localStorage.setItem('exs', JSON.stringify(state.exceptions));
        };

        const fmtDate = (d) => {
            const date = new Date(d);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        const getEvents = (date) => {
            const dStr = fmtDate(date);
            const dow = date.getDay();
            return state.events.filter(e => {
                // 檢查例外排除
                if (state.exceptions.some(ex => ex.id === e.id && ex.date === dStr)) return false;

                if (e.isRecurring) {
                    const start = new Date(e.date);
                    const current = new Date(dStr);
                    if (current < start) return false;
                    if (e.endDate && current > new Date(e.endDate)) return false;
                    return e.repeatDays.includes(dow);
                }
                return e.date === dStr;
            }).sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
        };

        // --- 渲染函數 ---
        const render = () => {
            renderHeader();
            renderMain();
            renderFooter();
            save();
        };

        const renderHeader = () => {
            const d = state.currentDate;
            document.getElementById('app-header').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-black text-slate-800">${d.getFullYear()}年 ${d.getMonth()+1}月</h1>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setView('month')" class="p-2.5 rounded-xl ${state.view==='month'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.calendar}</button>
                        <button onclick="setView('day')" class="p-2.5 rounded-xl ${state.view==='day'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.days}</button>
                        <button onclick="setView('items')" class="p-2.5 rounded-xl ${state.view==='items'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.layers}</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="moveMonth(-1)" class="p-2 bg-slate-50 rounded-xl">◀</button>
                    <button onclick="state.currentDate=new Date(); render();" class="px-4 py-2 bg-slate-50 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-500">TODAY</button>
                    <button onclick="moveMonth(1)" class="p-2 bg-slate-50 rounded-xl">▶</button>
                </div>
            `;
        };

        const renderMain = () => {
            const main = document.getElementById('app-main');
            if (state.view === 'month') {
                const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
                const first = new Date(y, m, 1).getDay(), num = new Date(y, m+1, 0).getDate();
                const days = [...Array(first).fill(null), ...Array(num).fill(0).map((_,i)=>new Date(y,m,i+1))];
                main.innerHTML = `
                    <div class="grid grid-cols-7 gap-px bg-slate-100 rounded-[24px] overflow-hidden border border-slate-50 animate-in shadow-sm">
                        ${['日','一','二','三','四','五','六'].map(d=>`<div class="bg-white p-3 text-center text-[10px] font-bold text-slate-300">${d}</div>`).join('')}
                        ${days.map(day => {
                            if(!day) return `<div class="bg-slate-50/50 min-h-[95px]"></div>`;
                            const evs = getEvents(day);
                            const isToday = fmtDate(day) === fmtDate(new Date());
                            return `
                                <div onclick="state.currentDate=new Date('${day}'); state.view='day'; render();" class="day-cell bg-white p-1">
                                    <div class="text-[10px] mb-1 flex justify-center items-center w-6 h-6 mx-auto font-black ${isToday?'bg-blue-600 text-white rounded-full':''}">${day.getDate()}</div>
                                    <div class="space-y-0.5">${evs.slice(0,3).map(e=>`<div class="text-[8px] px-1 truncate rounded border font-bold" style="background:${findCat(e.type).color}25; border-color:${findCat(e.type).color}">${e.title}</div>`).join('')}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (state.view === 'day') {
                const evs = getEvents(state.currentDate);
                main.innerHTML = `
                    <div class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-50 min-h-[450px] animate-in">
                        <h2 class="text-xl font-black mb-6">${fmtDate(state.currentDate)}</h2>
                        <div class="space-y-4">
                            ${evs.map(e => `
                                <div onclick="openEventForm('edit', '${e.id}')" class="p-5 rounded-3xl border flex justify-between items-center cursor-pointer hover:shadow-md transition-all" style="border-left:5px solid ${findCat(e.type).color}; background:${findCat(e.type).color}10">
                                    <div>
                                        <div class="text-[10px] font-black opacity-40 uppercase tracking-widest">${e.hasTime?e.time:'全天'}</div>
                                        <div class="font-bold text-slate-700">${e.title}</div>
                                        ${e.desc ? `<div class="text-[10px] text-slate-400 mt-1">${e.desc}</div>` : ''}
                                    </div>
                                    <span class="text-slate-300">▶</span>
                                </div>
                            `).join('')}
                            ${evs.length===0?'<div class="py-24 text-center opacity-20 font-black">今日無計畫</div>':''}
                        </div>
                    </div>
                `;
            } else {
                main.innerHTML = `
                    <div class="space-y-4 animate-in">
                        <button onclick="openCategoryModal()" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-black">+ 新增分類項目</button>
                        ${state.categories.map(c => `
                            <div class="bg-white p-6 rounded-3xl border border-slate-50 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-4">
                                    <div class="w-4 h-4 rounded-full" style="background:${c.color}"></div>
                                    <span class="font-black text-slate-700">${c.name}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="openEventForm('add', null, '${c.id}')" class="p-2 bg-blue-50 text-blue-500 rounded-xl">${SVG.plus}</button>
                                    <button onclick="deleteCat('${c.id}')" class="p-2 text-slate-200 hover:text-red-500">${SVG.trash}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        };

        const renderFooter = () => {
            document.getElementById('app-footer').innerHTML = `
                <div class="pl-6 text-sm font-black text-blue-400">${fmtDate(state.currentDate)}</div>
                <button onclick="openEventForm('add')" class="bg-blue-600 w-14 h-14 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-all text-white">${SVG.plus}</button>
            `;
        };

        // --- 功能邏輯 ---
        const setView = (v) => { state.view = v; render(); };
        const moveMonth = (n) => { state.currentDate.setMonth(state.currentDate.getMonth()+n); render(); };
        const findCat = (id) => state.categories.find(c=>c.id===id) || state.categories[0];

        // --- 行程表單 ---
        const openEventForm = (mode, id = null, catId = null) => {
            state.editScope = 'series';
            if (mode === 'add') {
                state.tempEv = { id:Date.now().toString(), title:'', desc:'', type: catId || state.categories[0].id, date:fmtDate(state.currentDate), hasTime:false, time:'12:00', isRecurring:false, repeatDays:[], endDate:'' };
            } else {
                const target = state.events.find(e=>e.id===id);
                state.tempEv = JSON.parse(JSON.stringify(target));
                // 如果是編輯，確保日期是當前選擇的日期（針對重複行程）
                if (state.tempEv.isRecurring) state.tempEv.date = fmtDate(state.currentDate);
            }
            renderEventModal(mode);
        };

        const renderEventModal = (mode) => {
            const f = state.tempEv;
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-end justify-center modal-overlay">
                    <div class="bg-white w-full max-w-md rounded-t-[40px] p-8 animate-in overflow-y-auto max-h-[90vh] no-scrollbar">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black">${mode==='add'?'規劃新計畫':'修改計畫內容'}</h2>
                            <button onclick="closeModal()">${SVG.x}</button>
                        </div>
                        <div class="space-y-5">
                            ${(mode==='edit' && f.isRecurring) ? `
                                <div class="flex p-1 bg-slate-100 rounded-2xl mb-4 text-[11px] font-black">
                                    <button onclick="state.editScope='series'; renderEventModal('edit')" class="flex-1 py-3 rounded-xl ${state.editScope==='series'?'bg-white shadow text-blue-600':'text-slate-400'}">修改整個系列</button>
                                    <button onclick="state.editScope='single'; renderEventModal('edit')" class="flex-1 py-3 rounded-xl ${state.editScope==='single'?'bg-white shadow text-blue-600':'text-slate-400'}">僅修改這一次</button>
                                </div>
                            ` : ''}
                            
                            <input id="f-title" type="text" placeholder="計畫標題" value="${f.title}" class="font-bold text-lg">
                            <textarea id="f-desc" placeholder="說明欄 (自由填寫)" rows="2" class="text-sm">${f.desc || ''}</textarea>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-black text-slate-300 block mb-1">日期</label><input id="f-date" type="date" value="${f.date}"></div>
                                <div><label class="text-[10px] font-black text-slate-300 block mb-1">時間</label><input id="f-time" type="time" value="${f.time}" ${!f.hasTime?'disabled opacity-20':''}></div>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <span class="font-black text-xs">啟用具體時間</span>
                                <input type="checkbox" ${f.hasTime?'checked':''} onchange="state.tempEv.hasTime=this.checked; state.tempEv.title=document.getElementById('f-title').value; state.tempEv.desc=document.getElementById('f-desc').value; renderEventModal('${mode}')">
                            </div>

                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <span class="font-black text-xs text-green-600">每週重複計畫</span>
                                <input type="checkbox" ${f.isRecurring?'checked':''} onchange="state.tempEv.isRecurring=this.checked; state.tempEv.title=document.getElementById('f-title').value; state.tempEv.desc=document.getElementById('f-desc').value; renderEventModal('${mode}')">
                            </div>

                            ${f.isRecurring ? `
                                <div class="space-y-4 p-4 border-2 border-slate-50 rounded-3xl">
                                    <div class="flex justify-between">${['日','一','二','三','四','五','六'].map((d,i)=>`<button onclick="toggleDay(${i})" class="w-8 h-8 rounded-lg text-[10px] font-bold ${f.repeatDays.includes(i)?'bg-blue-600 text-white':'bg-slate-100 text-slate-400'}">${d}</button>`).join('')}</div>
                                    <div class="flex items-center justify-between pt-2">
                                        <span class="text-[10px] font-black text-slate-400">重複截止日期 (選填)</span>
                                        <input id="f-endDate" type="date" value="${f.endDate || ''}" class="!w-auto !p-2 !text-xs">
                                    </div>
                                </div>
                            ` : ''}

                            <div class="grid grid-cols-3 gap-2">
                                ${state.categories.map(c=>`<button onclick="state.tempEv.type='${c.id}'; state.tempEv.title=document.getElementById('f-title').value; renderEventModal('${mode}')" class="p-2 rounded-xl border-2 text-[10px] font-bold ${f.type===c.id?'border-slate-800 bg-slate-800 text-white':'border-slate-50 text-slate-400'}">${c.name}</button>`).join('')}
                            </div>

                            <div class="flex gap-2">
                                <button onclick="saveEvent('${mode}')" class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">儲存計畫</button>
                                ${mode==='edit' ? `<button onclick="deleteEvent()" class="flex-1 py-4 bg-red-50 text-red-500 rounded-2xl font-bold">${SVG.trash}</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const toggleDay = (i) => {
            let days = state.tempEv.repeatDays;
            state.tempEv.repeatDays = days.includes(i) ? days.filter(x=>x!==i) : [...days, i];
            state.tempEv.title = document.getElementById('f-title').value;
            state.tempEv.desc = document.getElementById('f-desc').value;
            renderEventModal(state.tempEv.id ? 'edit' : 'add');
        };

        const saveEvent = (mode) => {
            const title = document.getElementById('f-title').value;
            if(!title) return alert('請輸入標題');
            
            state.tempEv.title = title;
            state.tempEv.desc = document.getElementById('f-desc').value;
            state.tempEv.date = document.getElementById('f-date').value;
            if (state.tempEv.hasTime) state.tempEv.time = document.getElementById('f-time').value;
            if (state.tempEv.isRecurring && document.getElementById('f-endDate')) state.tempEv.endDate = document.getElementById('f-endDate').value;

            if (mode === 'add') {
                state.events.push(state.tempEv);
            } else {
                if (state.editScope === 'single' && state.tempEv.isRecurring) {
                    // 單次修改：在例外中加入日期，並新增一個單獨的非重複行程
                    state.exceptions.push({ id: state.tempEv.id, date: fmtDate(state.currentDate) });
                    const singleEv = { ...state.tempEv, id: Date.now().toString(), isRecurring: false };
                    state.events.push(singleEv);
                } else {
                    // 系列修改
                    state.events = state.events.map(e => e.id === state.tempEv.id ? state.tempEv : e);
                }
            }
            closeModal();
            render();
        };

        const deleteEvent = () => {
            if (state.tempEv.isRecurring) {
                if (confirm('要刪除整個系列嗎？')) {
                    state.events = state.events.filter(e => e.id !== state.tempEv.id);
                } else {
                    state.exceptions.push({ id: state.tempEv.id, date: fmtDate(state.currentDate) });
                }
            } else {
                state.events = state.events.filter(e => e.id !== state.tempEv.id);
            }
            closeModal();
            render();
        };

        // --- 類別管理 ---
        const openCategoryModal = () => {
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-6 modal-overlay">
                    <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl relative">
                        <button onclick="closeModal()" class="absolute top-6 right-6">${SVG.x}</button>
                        <h3 class="font-black mb-6">新增項目分類</h3>
                        <input id="c-name" type="text" placeholder="分類名稱" class="mb-4">
                        <input id="c-color" type="color" value="#3B82F6" class="w-full h-10 mb-8 bg-transparent">
                        <button onclick="addCat()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black">儲存分類</button>
                    </div>
                </div>
            `;
        };

        const addCat = () => {
            const name = document.getElementById('c-name').value;
            const color = document.getElementById('c-color').value;
            if(!name) return;
            state.categories.push({ id: Date.now().toString(), name, color });
            closeModal();
            render();
        };

        const deleteCat = (id) => {
            if(state.categories.length <= 1) return;
            state.categories = state.categories.filter(c=>c.id!==id);
            state.events = state.events.filter(e=>e.type!==id);
            render();
        };

        const closeModal = () => document.getElementById('modal-container').innerHTML = '';
        window.onload = render;
    </script>
</body>
</html>
