<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>個人化行事曆 - 穩定最終版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8FAFC; color: #1E293B; -webkit-tap-highlight-color: transparent; }
        
        /* 文字內距統一對齊 */
        input[type="text"], textarea { 
            background-color: #F1F5F9; border: none; border-radius: 16px; 
            padding: 18px 24px !important; width: 100%; outline: none; font-weight: 500; font-size: 16px; 
        }
        textarea { min-height: 120px; resize: none; line-height: 1.6; }
        
        input[type="date"], input[type="time"] { 
            background-color: #F1F5F9; border-radius: 12px; padding: 10px; font-weight: bold; border: none; outline: none;
        }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); }
        .animate-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* 截止日底色樣式 */
        .end-date-box { background-color: #EBF2FF; border-radius: 16px; padding: 12px 16px; transition: all 0.2s; }

        .day-cell { min-height: 105px; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .hidden-section { display: none !important; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32 relative shadow-2xl bg-white">

    <header id="app-header" class="p-6 bg-white/90 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-100"></header>
    <main id="app-main" class="p-5"></main>
    <div id="app-footer" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-[360px] bg-slate-900 shadow-2xl text-white p-3 rounded-[32px] flex justify-between items-center z-50"></div>
    <div id="modal-container"></div>

    <script>
        const SVG = {
            calendar: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
            days: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 2v4M16 2v4M3 10h18M21 4H3v16h18z"/></svg>',
            layers: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2 2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
            plus: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5v14"/></svg>',
            x: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>',
            trash: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>',
            chevron: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>'
        };

        let state = {
            currentDate: new Date(),
            view: 'month',
            categories: JSON.parse(localStorage.getItem('cats')) || [
                { id: 'c1', name: '工作項目', color: '#1E293B' },
                { id: 'c2', name: '畫畫創作', color: '#EC4899' },
                { id: 'c3', name: '生活日常', color: '#10B981' }
            ],
            events: JSON.parse(localStorage.getItem('evs')) || [],
            exceptions: JSON.parse(localStorage.getItem('exs')) || [],
            showDatePicker: false,
            tempEv: {},
            editScope: 'series'
        };

        const save = () => {
            localStorage.setItem('cats', JSON.stringify(state.categories));
            localStorage.setItem('evs', JSON.stringify(state.events));
            localStorage.setItem('exs', JSON.stringify(state.exceptions));
        };

        const fmtISO = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

        const render = () => {
            renderHeader();
            renderMain();
            renderFooter();
            save();
        };

        const renderHeader = () => {
            const d = state.currentDate;
            const months = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
            document.getElementById('app-header').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="relative">
                        <button onclick="state.showDatePicker = !state.showDatePicker; render();" class="flex items-center gap-2 text-2xl font-black text-slate-800">
                            ${d.getFullYear()}年 ${months[d.getMonth()]} ${SVG.chevron}
                        </button>
                        ${state.showDatePicker ? `
                        <div class="absolute top-12 left-0 w-64 bg-white shadow-2xl rounded-3xl p-4 z-50 animate-up border border-slate-100">
                            <div class="flex items-center justify-between mb-4 px-2">
                                <button onclick="changeYear(-1)" class="p-2 hover:bg-slate-50 rounded-xl">◀</button>
                                <span class="font-black">${d.getFullYear()}</span>
                                <button onclick="changeYear(1)" class="p-2 hover:bg-slate-50 rounded-xl">▶</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                ${months.map((m, i) => `<button onclick="setMonth(${i})" class="py-2 text-sm font-bold rounded-xl ${d.getMonth() === i ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-50 text-slate-500'}">${m}</button>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setView('month')" class="p-2.5 rounded-xl ${state.view==='month'?'bg-white shadow text-blue-600':'text-gray-400'}">${SVG.calendar}</button>
                        <button onclick="setView('day')" class="p-2.5 rounded-xl ${state.view==='day'?'bg-white shadow text-blue-600':'text-gray-400'}">${SVG.days}</button>
                        <button onclick="setView('items')" class="p-2.5 rounded-xl ${state.view==='items'?'bg-white shadow text-blue-600':'text-gray-400'}">${SVG.layers}</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="navigate(-1)" class="p-2 bg-slate-50 rounded-xl text-slate-400">◀</button>
                    <button onclick="state.currentDate=new Date(); render();" class="px-4 py-2 bg-slate-50 rounded-xl text-[10px] font-black uppercase text-slate-500">TODAY</button>
                    <button onclick="navigate(1)" class="p-2 bg-slate-50 rounded-xl text-slate-400">▶</button>
                </div>
            `;
        };

        const changeYear = (dir) => { state.currentDate.setFullYear(state.currentDate.getFullYear() + dir); render(); };
        const setMonth = (m) => { state.currentDate.setMonth(m); state.showDatePicker = false; render(); };
        const setView = (v) => { state.view = v; render(); };
        const navigate = (dir) => {
            if (state.view === 'day') state.currentDate.setDate(state.currentDate.getDate() + dir);
            else state.currentDate.setMonth(state.currentDate.getMonth() + dir);
            render();
        };

        const renderMain = () => {
            const main = document.getElementById('app-main');
            if (state.view === 'month') {
                const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
                const first = new Date(y, m, 1).getDay(), num = new Date(y, m+1, 0).getDate();
                const days = [...Array(first).fill(null), ...Array(num).fill(0).map((_,i)=>new Date(y,m,i+1))];
                main.innerHTML = `
                    <div class="grid grid-cols-7 gap-px bg-slate-100 rounded-[24px] overflow-hidden border border-slate-50 shadow-sm animate-up">
                        ${['日','一','二','三','四','五','六'].map(d=>`<div class="bg-white p-3 text-center text-[10px] font-bold text-slate-300">${d}</div>`).join('')}
                        ${days.map(day => {
                            if(!day) return `<div class="bg-slate-50/50 min-h-[95px]"></div>`;
                            const evs = getEventsForDay(day);
                            const isToday = fmtISO(day) === fmtISO(new Date());
                            return `<div onclick="state.currentDate=new Date('${day}'); state.view='day'; render();" class="day-cell bg-white p-1">
                                <div class="text-[10px] mb-1 flex justify-center items-center w-6 h-6 mx-auto font-black ${isToday?'bg-blue-600 text-white rounded-full':''}">${day.getDate()}</div>
                                <div class="space-y-0.5">${evs.slice(0,3).map(e=>`<div class="text-[8px] px-1 truncate rounded border font-bold" style="background:${findCat(e.type).color}15; border-color:${findCat(e.type).color}">${e.title}</div>`).join('')}</div>
                            </div>`;
                        }).join('')}
                    </div>`;
            } else if (state.view === 'day') {
                const evs = getEventsForDay(state.currentDate);
                main.innerHTML = `<div class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-50 min-h-[450px] animate-up">
                    <h2 class="text-xl font-black mb-6">${state.currentDate.toLocaleDateString()}</h2>
                    <div class="space-y-4">
                        ${evs.map(e => `<div onclick="openEventForm('edit', '${e.id}')" class="p-5 rounded-3xl border flex justify-between items-center cursor-pointer hover:shadow-md transition-all" style="border-left:6px solid ${findCat(e.type).color}; background:${findCat(e.type).color}08">
                            <div class="flex-1"><div class="text-[10px] font-black opacity-40 uppercase">${e.hasTime?e.time:'全天'}</div><div class="font-bold text-slate-700">${e.title}</div></div>
                            <span class="text-slate-200">▶</span>
                        </div>`).join('')}
                        ${evs.length===0?'<div class="py-24 text-center opacity-20 font-black">今日無計畫</div>':''}
                    </div>
                </div>`;
            } else {
                main.innerHTML = `<div class="space-y-4 animate-up">
                    <button onclick="openCategoryModal('add')" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-black">+ 新增項目分類</button>
                    ${state.categories.map((c, idx) => `
                        <div class="bg-white p-6 rounded-3xl border border-slate-50 flex justify-between items-center shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="w-4 h-4 rounded-full shadow-inner" style="background:${c.color}"></div>
                                <span class="font-black text-slate-700">${c.name}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="reorderCat(${idx}, -1)" class="p-2 text-slate-300">▲</button>
                                <button onclick="openEventForm('add', null, '${c.id}')" class="p-2 bg-blue-50 text-blue-500 rounded-xl">${SVG.plus}</button>
                                <button onclick="openCategoryModal('edit', '${c.id}')" class="p-2 text-slate-300">✎</button>
                            </div>
                        </div>`).join('')}
                </div>`;
            }
        };

        const getEventsForDay = (date) => {
            const dStr = fmtISO(date);
            return state.events.filter(e => {
                if (state.exceptions.some(ex => ex.id === e.id && ex.date === dStr)) return false;
                if (e.isRecurring) {
                    if (new Date(dStr) < new Date(e.date)) return false;
                    if (e.endDate && new Date(dStr) > new Date(e.endDate)) return false;
                    return e.repeatDays.includes(date.getDay());
                }
                return e.date === dStr;
            }).sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
        };

        const renderFooter = () => {
            document.getElementById('app-footer').innerHTML = `
                <div class="pl-6 text-sm font-black text-blue-400">${state.currentDate.toLocaleDateString()}</div>
                <button onclick="openEventForm('add')" class="bg-blue-600 w-14 h-14 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-all text-white">${SVG.plus}</button>
            `;
        };

        const reorderCat = (idx, dir) => {
            const target = idx + dir;
            if (target >= 0 && target < state.categories.length) {
                const temp = state.categories[idx];
                state.categories[idx] = state.categories[target];
                state.categories[target] = temp;
                render();
            }
        };

        const findCat = (id) => state.categories.find(c=>c.id===id) || state.categories[0];
        const closeModal = () => document.getElementById('modal-container').innerHTML = '';

        // --- 行程彈窗修復 ---
        const openEventForm = (mode, id = null, catId = null) => {
            state.editScope = 'series';
            if (mode === 'add') {
                state.tempEv = { id:Date.now().toString(), title:'', desc:'', type: catId || state.categories[0].id, date:fmtISO(state.currentDate), hasTime:false, time:'12:00', isRecurring:false, repeatDays:[], endDate:'' };
            } else {
                state.tempEv = JSON.parse(JSON.stringify(state.events.find(e=>e.id===id)));
                if (state.tempEv.isRecurring) state.tempEv.date = fmtISO(state.currentDate);
            }
            renderEventModal(mode);
        };

        const renderEventModal = (mode) => {
            const f = state.tempEv;
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-end justify-center modal-overlay">
                    <div class="bg-white w-full max-w-md rounded-t-[48px] p-8 animate-up overflow-y-auto max-h-[90vh] no-scrollbar shadow-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black text-slate-800">計畫詳情</h2>
                            <button onclick="closeModal()">${SVG.x}</button>
                        </div>
                        <div class="space-y-6">
                            ${(mode==='edit' && f.isRecurring) ? `
                                <div class="flex p-1 bg-slate-100 rounded-2xl mb-4 text-[11px] font-black">
                                    <button onclick="setScope('series')" class="flex-1 py-3 rounded-xl ${state.editScope==='series'?'bg-white shadow text-blue-600':'text-slate-400'}">全部修改</button>
                                    <button onclick="setScope('single')" class="flex-1 py-3 rounded-xl ${state.editScope==='single'?'bg-white shadow text-blue-600':'text-slate-400'}">僅修這次</button>
                                </div>` : ''}
                            
                            <input id="f-title" type="text" placeholder="計畫標題" value="${f.title}" oninput="state.tempEv.title=this.value">
                            <textarea id="f-desc" placeholder="說明欄 (自由選填)" oninput="state.tempEv.desc=this.value">${f.desc || ''}</textarea>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                    <span class="font-black text-xs text-slate-600">日期</span>
                                    <input type="date" value="${f.date}" class="!w-auto !bg-transparent !p-0 font-black text-right" onchange="state.tempEv.date=this.value">
                                </div>
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                    <div class="flex items-center gap-2">
                                        <span class="font-black text-xs text-slate-600">具體時間</span>
                                        <input type="checkbox" class="w-5 h-5 accent-blue-600 cursor-pointer" ${f.hasTime?'checked':''} onchange="toggleTimeUI(this.checked)">
                                    </div>
                                    <input type="time" id="f-time" value="${f.time}" class="!w-auto !bg-transparent !p-0 font-black text-right ${f.hasTime?'':'hidden'}" onchange="state.tempEv.time=this.value">
                                </div>
                            </div>

                            <div id="recurring-box" class="${(mode==='edit' && state.editScope==='single')?'hidden':''}">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl mb-4">
                                    <span class="font-black text-xs text-green-600 uppercase">重複日期</span>
                                    <input type="checkbox" class="w-5 h-5 accent-green-600 cursor-pointer" ${f.isRecurring?'checked':''} onchange="toggleRepeatUI(this.checked)">
                                </div>

                                <div id="repeat-detail" class="${f.isRecurring?'':'hidden'} space-y-4 p-5 border-2 border-slate-50 rounded-[32px]">
                                    <div class="flex justify-between">
                                        ${['日','一','二','三','四','五','六'].map((d,i)=>`
                                            <div onclick="toggleDay(${i}, this)" 
                                                class="w-8 h-8 flex items-center justify-center rounded-xl text-[10px] font-bold cursor-pointer transition-all 
                                                ${f.repeatDays.includes(i)?'bg-blue-600 text-white shadow-lg shadow-blue-200':'bg-slate-100 text-slate-400'}">${d}</div>
                                        `).join('')}
                                    </div>
                                    <div class="end-date-box flex items-center justify-between mt-2">
                                        <span class="text-[10px] font-black text-blue-600 uppercase">重複截止日期</span>
                                        <input type="date" value="${f.endDate || ''}" onchange="state.tempEv.endDate=this.value" class="!w-auto !bg-transparent !p-0 font-black">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-2">
                                ${state.categories.map(c=>`<button onclick="setCat('${c.id}', this)" class="p-3 rounded-2xl border-2 text-[10px] font-black ${f.type===c.id?'border-slate-800 bg-slate-800 text-white shadow-md':'border-slate-50 text-slate-300'}">${c.name}</button>`).join('')}
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button onclick="saveEvent('${mode}')" class="flex-[4] py-5 bg-blue-600 text-white rounded-[24px] font-black text-lg shadow-xl shadow-blue-200 active:scale-95 transition-all">儲存計畫</button>
                                ${mode==='edit' ? `<button onclick="deleteEvent()" class="flex-1 bg-red-50 text-red-500 rounded-[24px] flex items-center justify-center">${SVG.trash}</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        const toggleTimeUI = (on) => { state.tempEv.hasTime = on; document.getElementById('f-time').classList.toggle('hidden', !on); };
        const toggleRepeatUI = (on) => { state.tempEv.isRecurring = on; document.getElementById('repeat-detail').classList.toggle('hidden', !on); };
        const setScope = (s) => { state.editScope = s; renderEventModal('edit'); };
        
        const toggleDay = (idx, el) => {
            let days = state.tempEv.repeatDays;
            if (days.includes(idx)) {
                state.tempEv.repeatDays = days.filter(i => i !== idx);
                el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-200');
                el.classList.add('bg-slate-100', 'text-slate-400');
            } else {
                state.tempEv.repeatDays.push(idx);
                el.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-200');
                el.classList.remove('bg-slate-100', 'text-slate-400');
            }
        };

        const setCat = (id, btn) => {
            state.tempEv.type = id;
            btn.parentElement.querySelectorAll('button').forEach(b=>b.className='p-3 rounded-2xl border-2 text-[10px] font-black border-slate-50 text-slate-300');
            btn.className='p-3 rounded-2xl border-2 text-[10px] font-black border-slate-800 bg-slate-800 text-white shadow-md';
        };

        const saveEvent = (mode) => {
            if(!state.tempEv.title) return alert('請輸入標題');
            if (mode === 'edit' && state.editScope === 'single' && state.tempEv.isRecurring) {
                state.exceptions.push({ id: state.tempEv.id, date: state.tempEv.date });
                state.events.push({ ...state.tempEv, id: Date.now().toString(), isRecurring: false });
            } else {
                state.events = [...state.events.filter(e => e.id !== state.tempEv.id), state.tempEv];
            }
            closeModal(); render();
        };

        const deleteEvent = () => { state.events = state.events.filter(e => e.id !== state.tempEv.id); closeModal(); render(); };
        
        const openCategoryModal = (mode, id = null) => {
            let cat = mode === 'edit' ? state.categories.find(c => c.id === id) : { name: '', color: '#1E293B' };
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-6 modal-overlay">
                    <div class="bg-white w-full max-w-xs rounded-[40px] p-10 shadow-2xl relative animate-up">
                        <button onclick="closeModal()" class="absolute top-6 right-6 p-2">${SVG.x}</button>
                        <h3 class="font-black mb-8 text-center text-xl tracking-tighter">項目分類</h3>
                        <div class="space-y-4">
                            <input id="c-name" type="text" placeholder="項目名稱" value="${cat.name}">
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <span class="text-xs font-bold text-slate-400 uppercase">代表顏色</span>
                                <input id="c-color" type="color" value="${cat.color}">
                            </div>
                            <button onclick="saveCat('${mode}', '${id}')" class="w-full py-5 bg-slate-900 text-white rounded-3xl font-black shadow-lg">確認儲存</button>
                            ${mode==='edit' ? `<button onclick="deleteCat('${id}')" class="w-full py-3 text-red-400 font-bold">刪除</button>` : ''}
                        </div>
                    </div>
                </div>`;
        };

        const saveCat = (mode, id) => {
            const name = document.getElementById('c-name').value;
            const color = document.getElementById('c-color').value;
            if(!name) return;
            if (mode === 'add') state.categories.push({ id: Date.now().toString(), name, color });
            else state.categories = state.categories.map(c => c.id === id ? {...c, name, color} : c);
            closeModal(); render();
        };

        const deleteCat = (id) => { state.categories = state.categories.filter(c => c.id !== id); closeModal(); render(); };

        window.onload = render;
    </script>
</body>
</html>
