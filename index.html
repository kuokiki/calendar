<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極簡行事曆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="date"], input[type="time"] { appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // 解構 React 常用 Hooks
        const { useState, useEffect, useMemo } = React;

        // 輔助函數：顏色轉換
        const getLightColor = (hex) => {
            if (!hex || !hex.startsWith('#')) return '#F3F4F6';
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, 0.15)`;
        };

        const WEEKDAYS = ['日', '一', '二', '三', '四', '五', '六'];
        const MONTHS = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

        const App = () => {
            // --- 狀態初始化 ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('month');
            
            // 從 LocalStorage 讀取資料或使用預設值
            const [categories, setCategories] = useState(() => {
                const saved = localStorage.getItem('cal_categories');
                return saved ? JSON.parse(saved) : [
                    { id: 'work', name: '工作項目', color: '#3B82F6', lightColor: 'rgba(59, 130, 246, 0.1)' },
                    { id: 'life', name: '生活日常', color: '#10B981', lightColor: 'rgba(16, 185, 129, 0.1)' }
                ];
            });

            const [events, setEvents] = useState(() => {
                const saved = localStorage.getItem('cal_events');
                return saved ? JSON.parse(saved) : [];
            });

            const [visibleLayers, setVisibleLayers] = useState(categories.map(c => c.id));
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showMonthPicker, setShowMonthPicker] = useState(false);
            const [selectedDetail, setSelectedDetail] = useState(null);
            
            const [formEvent, setFormEvent] = useState({
                title: '', type: 'work', date: '', hasTime: false, time: '12:00', isRecurring: false, repeatDays: []
            });

            // --- 持久化儲存 ---
            useEffect(() => {
                localStorage.setItem('cal_categories', JSON.stringify(categories));
                localStorage.setItem('cal_events', JSON.stringify(events));
            }, [categories, events]);

            // 每當畫面渲染，確保 Lucide 圖示被正確解析
            useEffect(() => {
                lucide.createIcons();
            });

            const formatKey = (date) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            const getEventsForDate = (date) => {
                if (!date) return [];
                const dateStr = formatKey(date);
                const dayOfWeek = date.getDay();
                return events.filter(ev => {
                    if (!visibleLayers.includes(ev.type)) return false;
                    if (ev.isRecurring) {
                        return new Date(dateStr) >= new Date(ev.date) && ev.repeatDays.includes(dayOfWeek);
                    }
                    return ev.date === dateStr;
                }).sort((a, b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
            };

            // --- 視圖組件 ---
            const MonthView = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const numDays = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(null);
                for (let i = 1; i <= numDays; i++) days.push(new Date(year, month, i));

                return (
                    <div className="grid grid-cols-7 gap-px bg-slate-200 rounded-3xl overflow-hidden border border-slate-200 shadow-sm">
                        {WEEKDAYS.map(d => (
                            <div key={d} className="bg-white py-3 text-center text-[10px] font-bold text-slate-400">{d}</div>
                        ))}
                        {days.map((day, i) => {
                            const evs = getEventsForDate(day);
                            const isToday = day && formatKey(day) === formatKey(new Date());
                            return (
                                <div key={i} onClick={() => day && (setCurrentDate(day), setView('day'))}
                                    className={`bg-white min-h-[90px] p-1 ${day ? 'cursor-pointer hover:bg-slate-50' : ''}`}>
                                    {day && (
                                        <>
                                            <div className={`text-xs w-6 h-6 flex items-center justify-center mx-auto mb-1 font-bold rounded-full ${isToday ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>
                                                {day.getDate()}
                                            </div>
                                            <div className="space-y-1">
                                                {evs.slice(0, 3).map(ev => (
                                                    <div key={ev.id} className="text-[8px] px-1 py-0.5 rounded truncate border font-medium"
                                                        style={{ background: getLightColor(categories.find(c=>c.id===ev.type)?.color), borderColor: categories.find(c=>c.id===ev.type)?.color }}>
                                                        {ev.title}
                                                    </div>
                                                ))}
                                            </div>
                                        </>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative shadow-2xl bg-white">
                    {/* Header */}
                    <header className="p-6 sticky top-0 bg-white/90 backdrop-blur-md z-30 border-b border-slate-100">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={() => setShowMonthPicker(!showMonthPicker)} className="flex items-center gap-2 text-xl font-black text-slate-800">
                                {currentDate.getFullYear()}年 {MONTHS[currentDate.getMonth()]}
                                <i data-lucide="chevron-down" className="w-5 h-5 text-slate-400"></i>
                            </button>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                <button onClick={() => setView('month')} className={`p-2 rounded-lg ${view==='month' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}><i data-lucide="calendar" className="w-4 h-4"></i></button>
                                <button onClick={() => setView('day')} className={`p-2 rounded-lg ${view==='day' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}><i data-lucide="calendar-days" className="w-4 h-4"></i></button>
                            </div>
                        </div>
                        
                        <div className="flex items-center justify-between">
                            <div className="flex gap-2">
                                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="p-2 bg-slate-50 rounded-lg"><i data-lucide="chevron-left" className="w-4 h-4"></i></button>
                                <button onClick={() => setCurrentDate(new Date())} className="px-4 text-[10px] font-black bg-slate-50 rounded-lg uppercase tracking-widest text-slate-500">Today</button>
                                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="p-2 bg-slate-50 rounded-lg"><i data-lucide="chevron-right" className="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="p-4">
                        {view === 'month' ? <MonthView /> : (
                            <div className="space-y-4">
                                {getEventsForDate(currentDate).map(ev => (
                                    <div key={ev.id} className="flex gap-4 items-center">
                                        <div className="text-[10px] font-black text-slate-300 w-10 text-right">{ev.hasTime ? ev.time : 'ALL'}</div>
                                        <div className="flex-1 p-4 rounded-2xl border" style={{ background: getLightColor(categories.find(c=>c.id===ev.type)?.color), borderColor: categories.find(c=>c.id===ev.type)?.color }}>
                                            <div className="font-bold text-slate-700">{ev.title}</div>
                                        </div>
                                        <button onClick={() => setEvents(events.filter(e => e.id !== ev.id))} className="text-slate-300 hover:text-red-400"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* FAB Button */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[350px] flex justify-end z-40">
                        <button onClick={() => {
                            setFormEvent({...formEvent, date: formatKey(currentDate)});
                            setIsModalOpen(true);
                        }} className="w-14 h-14 bg-blue-600 rounded-2xl shadow-xl shadow-blue-200 text-white flex items-center justify-center active:scale-90 transition-transform">
                            <i data-lucide="plus" className="w-8 h-8"></i>
                        </button>
                    </div>

                    {/* Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-end">
                            <div className="bg-white w-full rounded-t-[40px] p-8 animate-in slide-in-from-bottom">
                                <div className="flex justify-between mb-6">
                                    <h2 className="text-xl font-black">新增行程</h2>
                                    <button onClick={() => setIsModalOpen(false)}><i data-lucide="x" className="w-6 h-6"></i></button>
                                </div>
                                <div className="space-y-4">
                                    <input type="text" placeholder="標題" value={formEvent.title} onChange={e=>setFormEvent({...formEvent, title: e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-blue-500" />
                                    <div className="flex gap-2">
                                        <input type="date" value={formEvent.date} onChange={e=>setFormEvent({...formEvent, date: e.target.value})} className="flex-1 p-3 bg-slate-50 rounded-xl text-sm" />
                                        <input type="time" value={formEvent.time} onChange={e=>setFormEvent({...formEvent, time: e.target.value})} className="flex-1 p-3 bg-slate-50 rounded-xl text-sm" />
                                    </div>
                                    <button onClick={() => {
                                        if(!formEvent.title) return;
                                        setEvents([...events, { ...formEvent, id: Date.now() }]);
                                        setIsModalOpen(false);
                                        setFormEvent({title: '', type: 'work', date: formatKey(currentDate), hasTime: false, time: '12:00', isRecurring: false, repeatDays: []});
                                    }} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">儲存行程</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
