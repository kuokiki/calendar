<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極簡行事曆 - 管理版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --accent-blue: #A3C4F3; --text-dark: #1E293B; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F9FBFD; color: var(--text-dark); -webkit-tap-highlight-color: transparent; }
        input[type="date"], input[type="time"], input[type="text"], textarea { 
            background-color: #F1F5F9; border: none; border-radius: 12px; padding: 14px 18px; width: 100%; outline: none; font-weight: 500; 
            line-height: 1.6; display: block;
        }
        /* 解決說明欄位置太左邊的問題 */
        textarea { padding: 16px 20px; min-height: 100px; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .day-cell { min-height: 105px; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32 relative shadow-2xl bg-white">

    <header id="app-header" class="p-6 bg-white/90 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-100"></header>
    <main id="app-main" class="p-5"></main>
    <div id="app-footer" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-[360px] bg-slate-900 shadow-2xl text-white p-3 rounded-[32px] flex justify-between items-center z-50"></div>
    <div id="modal-container"></div>

    <script>
        const SVG = {
            calendar: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
            days: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 2v4M16 2v4M3 10h18M21 4H3v16h18V4z"/></svg>',
            layers: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m12.83 2.18-9.07 4.32a2 2 0 0 0 0 3.38L12.83 14a2 2 0 0 0 1.66 0l9.07-4.32a2 2 0 0 0 0-3.38L13.66 2.18a2 2 0 0 0-1.66 0z"/><path d="m2.1 14.74 9.07 4.32a2 2 0 0 0 1.66 0l9.07-4.32"/><path d="m2.1 10.58 9.07 4.32a2 2 0 0 0 1.66 0l9.07-4.32"/></svg>',
            plus: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5v14"/></svg>',
            x: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>',
            trash: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>',
            edit: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            up: '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3"><path d="m18 15-6-6-6 6"/></svg>',
            down: '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>'
        };

        let state = {
            currentDate: new Date(),
            view: 'month',
            categories: JSON.parse(localStorage.getItem('cats')) || [
                { id: 'c1', name: '工作項目', color: '#A3C4F3' },
                { id: 'c2', name: '畫畫創作', color: '#EC4899' },
                { id: 'c3', name: '生活日常', color: '#CFEFDF' }
            ],
            events: JSON.parse(localStorage.getItem('evs')) || [],
            exceptions: JSON.parse(localStorage.getItem('exs')) || [],
            expandedCat: null, // 用於儲存哪個項目被展開看行程
            tempEv: {},
            editScope: 'series'
        };

        const save = () => {
            localStorage.setItem('cats', JSON.stringify(state.categories));
            localStorage.setItem('evs', JSON.stringify(state.events));
            localStorage.setItem('exs', JSON.stringify(state.exceptions));
        };

        const fmtDate = (d) => {
            const date = new Date(d);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        const getEventsByCat = (catId) => state.events.filter(e => e.type === catId);

        const getEventsForDay = (date) => {
            const dStr = fmtDate(date);
            const dow = date.getDay();
            return state.events.filter(e => {
                if (state.exceptions.some(ex => ex.id === e.id && ex.date === dStr)) return false;
                if (e.isRecurring) {
                    const start = new Date(e.date);
                    const current = new Date(dStr);
                    if (current < start) return false;
                    if (e.endDate && current > new Date(e.endDate)) return false;
                    return e.repeatDays.includes(dow);
                }
                return e.date === dStr;
            }).sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
        };

        const render = () => {
            renderHeader();
            renderMain();
            renderFooter();
            save();
        };

        const renderHeader = () => {
            const d = state.currentDate;
            document.getElementById('app-header').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-black text-slate-800">${d.getFullYear()}年 ${d.getMonth()+1}月</h1>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setView('month')" class="p-2.5 rounded-xl ${state.view==='month'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.calendar}</button>
                        <button onclick="setView('day')" class="p-2.5 rounded-xl ${state.view==='day'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.days}</button>
                        <button onclick="setView('items')" class="p-2.5 rounded-xl ${state.view==='items'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.layers}</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="navigate(-1)" class="p-2 bg-slate-50 rounded-xl text-slate-400">◀</button>
                    <button onclick="state.currentDate=new Date(); render();" class="px-4 py-2 bg-slate-50 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-500">TODAY</button>
                    <button onclick="navigate(1)" class="p-2 bg-slate-50 rounded-xl text-slate-400">▶</button>
                </div>
            `;
        };

        const navigate = (dir) => {
            if (state.view === 'day') state.currentDate.setDate(state.currentDate.getDate() + dir);
            else state.currentDate.setMonth(state.currentDate.getMonth() + dir);
            render();
        };

        const renderMain = () => {
            const main = document.getElementById('app-main');
            if (state.view === 'month') {
                const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
                const first = new Date(y, m, 1).getDay(), num = new Date(y, m+1, 0).getDate();
                const days = [...Array(first).fill(null), ...Array(num).fill(0).map((_,i)=>new Date(y,m,i+1))];
                main.innerHTML = `
                    <div class="grid grid-cols-7 gap-px bg-slate-100 rounded-[24px] overflow-hidden border border-slate-50 animate-in">
                        ${['日','一','二','三','四','五','六'].map(d=>`<div class="bg-white p-3 text-center text-[10px] font-bold text-slate-300">${d}</div>`).join('')}
                        ${days.map(day => {
                            if(!day) return `<div class="bg-slate-50/50 min-h-[95px]"></div>`;
                            const evs = getEventsForDay(day);
                            const isToday = fmtDate(day) === fmtDate(new Date());
                            return `
                                <div onclick="state.currentDate=new Date('${day}'); state.view='day'; render();" class="day-cell bg-white p-1">
                                    <div class="text-[10px] mb-1 flex justify-center items-center w-6 h-6 mx-auto font-black ${isToday?'bg-blue-600 text-white rounded-full':''}">${day.getDate()}</div>
                                    <div class="space-y-0.5">${evs.slice(0,3).map(e=>`<div class="text-[8px] px-1 truncate rounded border font-bold" style="background:${findCat(e.type).color}25; border-color:${findCat(e.type).color}">${e.title}</div>`).join('')}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (state.view === 'day') {
                const evs = getEventsForDay(state.currentDate);
                main.innerHTML = `
                    <div class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-50 min-h-[450px] animate-in">
                        <h2 class="text-xl font-black mb-6">${fmtDate(state.currentDate)}</h2>
                        <div class="space-y-4">
                            ${evs.map(e => `
                                <div onclick="openEventForm('edit', '${e.id}')" class="p-5 rounded-3xl border flex justify-between items-center cursor-pointer hover:shadow-md transition-all" style="border-left:5px solid ${findCat(e.type).color}; background:${findCat(e.type).color}10">
                                    <div class="flex-1">
                                        <div class="text-[10px] font-black opacity-40 uppercase tracking-widest">${e.hasTime?e.time:'全天'}</div>
                                        <div class="font-bold text-slate-700">${e.title}</div>
                                        ${e.desc ? `<div class="text-[11px] text-slate-400 mt-2 leading-relaxed">${e.desc}</div>` : ''}
                                    </div>
                                    <span class="text-slate-300 ml-4">▶</span>
                                </div>
                            `).join('')}
                            ${evs.length===0?'<div class="py-24 text-center opacity-20 font-black">今日無計畫</div>':''}
                        </div>
                    </div>
                `;
            } else {
                main.innerHTML = `
                    <div class="space-y-4 animate-in">
                        <button onclick="openCategoryModal('add')" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-black">+ 新增項目分類</button>
                        ${state.categories.map((c, idx) => {
                            const catEvs = getEventsByCat(c.id);
                            const isExpanded = state.expandedCat === c.id;
                            return `
                            <div class="bg-white rounded-3xl border border-slate-50 shadow-sm overflow-hidden">
                                <div class="p-6 flex justify-between items-center">
                                    <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="state.expandedCat = (state.expandedCat==='${c.id}'?null:'${c.id}'); render();">
                                        <div class="w-4 h-4 rounded-full" style="background:${c.color}"></div>
                                        <span class="font-black text-slate-700">${c.name} (${catEvs.length})</span>
                                    </div>
                                    <div class="flex gap-1 items-center">
                                        <div class="flex flex-col mr-2">
                                            <button onclick="reorderCat(${idx}, -1)" class="p-1 text-slate-300 hover:text-blue-500">${SVG.up}</button>
                                            <button onclick="reorderCat(${idx}, 1)" class="p-1 text-slate-300 hover:text-blue-500">${SVG.down}</button>
                                        </div>
                                        <button onclick="openEventForm('add', null, '${c.id}')" class="p-2 bg-blue-50 text-blue-500 rounded-xl">${SVG.plus}</button>
                                        <button onclick="openCategoryModal('edit', '${c.id}')" class="p-2 text-slate-300 hover:text-blue-500">${SVG.edit}</button>
                                    </div>
                                </div>
                                ${isExpanded ? `
                                    <div class="bg-slate-50/50 p-4 border-t border-slate-50 space-y-2">
                                        ${catEvs.map(e => `
                                            <div onclick="openEventForm('edit', '${e.id}')" class="text-xs p-3 bg-white rounded-xl border border-slate-100 flex justify-between cursor-pointer">
                                                <span class="font-bold text-slate-600">${e.title}</span>
                                                <span class="text-slate-300">${e.date}</span>
                                            </div>
                                        `).join('')}
                                        ${catEvs.length === 0 ? '<div class="text-center text-[10px] text-slate-300 py-2">尚無行程</div>' : ''}
                                    </div>
                                ` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                `;
            }
        };

        const renderFooter = () => {
            document.getElementById('app-footer').innerHTML = `
                <div class="pl-6 text-sm font-black text-blue-400">${fmtDate(state.currentDate)}</div>
                <button onclick="openEventForm('add')" class="bg-blue-600 w-14 h-14 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-all text-white">${SVG.plus}</button>
            `;
        };

        const findCat = (id) => state.categories.find(c=>c.id===id) || state.categories[0];
        const setView = (v) => { state.view = v; state.expandedCat = null; render(); };

        // --- 排序邏輯 ---
        const reorderCat = (idx, dir) => {
            const target = idx + dir;
            if (target >= 0 && target < state.categories.length) {
                const temp = state.categories[idx];
                state.categories[idx] = state.categories[target];
                state.categories[target] = temp;
                render();
            }
        };

        // --- 行程表單 ---
        const openEventForm = (mode, id = null, catId = null) => {
            state.editScope = 'series';
            if (mode === 'add') {
                state.tempEv = { id:Date.now().toString(), title:'', desc:'', type: catId || state.categories[0].id, date:fmtDate(state.currentDate), hasTime:false, time:'12:00', isRecurring:false, repeatDays:[], endDate:'' };
            } else {
                state.tempEv = JSON.parse(JSON.stringify(state.events.find(e=>e.id===id)));
                if (state.tempEv.isRecurring) state.tempEv.date = fmtDate(state.currentDate);
            }
            renderEventModal(mode);
        };

        const renderEventModal = (mode) => {
            const f = state.tempEv;
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-end justify-center modal-overlay">
                    <div class="bg-white w-full max-w-md rounded-t-[40px] p-8 animate-in overflow-y-auto max-h-[90vh]">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black">計畫詳情</h2>
                            <button onclick="closeModal()">${SVG.x}</button>
                        </div>
                        <div class="space-y-5">
                            <input id="f-title" type="text" placeholder="計畫標題" value="${f.title}" oninput="state.tempEv.title=this.value">
                            <textarea id="f-desc" placeholder="說明欄 (自由選填)" oninput="state.tempEv.desc=this.value">${f.desc || ''}</textarea>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-black text-slate-300 block mb-1">日期</label><input type="date" value="${f.date}" onchange="state.tempEv.date=this.value"></div>
                                <div id="time-box" style="${f.hasTime?'':'display:none'}"><label class="text-[10px] font-black text-slate-300 block mb-1">時間</label><input type="time" value="${f.time}" onchange="state.tempEv.time=this.value"></div>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <span class="font-black text-xs">具體時間</span>
                                <input type="checkbox" ${f.hasTime?'checked':''} onchange="state.tempEv.hasTime=this.checked; renderEventModal('${mode}')">
                            </div>

                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <span class="font-black text-xs text-green-600">重複日期</span>
                                <input type="checkbox" ${f.isRecurring?'checked':''} onchange="state.tempEv.isRecurring=this.checked; renderEventModal('${mode}')">
                            </div>

                            ${f.isRecurring ? `
                                <div class="p-4 border-2 border-slate-50 rounded-3xl space-y-4">
                                    <div class="flex justify-between">${['日','一','二','三','四','五','六'].map((d,i)=>`<button onclick="toggleDay(${i}, '${mode}')" class="w-8 h-8 rounded-lg text-[10px] font-bold ${f.repeatDays.includes(i)?'bg-blue-600 text-white':'bg-slate-100 text-slate-400'}">${d}</button>`).join('')}</div>
                                    <div class="flex items-center justify-between pt-2">
                                        <span class="text-[10px] font-black text-slate-400">截止日期</span>
                                        <input type="date" value="${f.endDate || ''}" onchange="state.tempEv.endDate=this.value" class="!w-auto !p-2 !text-xs">
                                    </div>
                                </div>` : ''}

                            <div class="grid grid-cols-3 gap-2">
                                ${state.categories.map(c=>`<button onclick="state.tempEv.type='${c.id}'; renderEventModal('${mode}')" class="p-2 rounded-xl border-2 text-[10px] font-bold ${f.type===c.id?'border-slate-800 bg-slate-800 text-white':'border-slate-50 text-slate-400'}">${c.name}</button>`).join('')}
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button onclick="saveEvent('${mode}')" class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">儲存</button>
                                ${mode==='edit'?`<button onclick="deleteEvent()" class="flex-1 py-4 bg-red-50 text-red-500 rounded-2xl font-bold">${SVG.trash}</button>`:''}
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        const toggleDay = (i, mode) => {
            let days = state.tempEv.repeatDays;
            state.tempEv.repeatDays = days.includes(i) ? days.filter(x=>x!==i) : [...days, i];
            renderEventModal(mode);
        };

        const saveEvent = (mode) => {
            if(!state.tempEv.title) return alert('請輸入標題');
            if (mode === 'add') state.events.push(state.tempEv);
            else state.events = state.events.map(e => e.id === state.tempEv.id ? state.tempEv : e);
            closeModal(); render();
        };

        const deleteEvent = () => {
            state.events = state.events.filter(e => e.id !== state.tempEv.id);
            closeModal(); render();
        };

        // --- 分類編輯 ---
        const openCategoryModal = (mode, id = null) => {
            let cat = { name: '', color: '#3B82F6' };
            if (mode === 'edit') cat = state.categories.find(c => c.id === id);
            
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-6 modal-overlay">
                    <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl relative animate-in">
                        <button onclick="closeModal()" class="absolute top-6 right-6">${SVG.x}</button>
                        <h3 class="font-black mb-6 text-center">${mode==='add'?'新增項目':'編輯項目'}</h3>
                        <input id="c-name" type="text" placeholder="項目名稱" class="mb-4" value="${cat.name}">
                        <input id="c-color" type="color" value="${cat.color}" class="w-full h-10 mb-8 bg-transparent">
                        <div class="flex gap-2">
                            <button onclick="saveCat('${mode}', '${id}')" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-black">儲存</button>
                            ${mode==='edit'?`<button onclick="deleteCat('${id}')" class="p-4 text-red-500 bg-red-50 rounded-2xl">${SVG.trash}</button>`:''}
                        </div>
                    </div>
                </div>`;
        };

        const saveCat = (mode, id) => {
            const name = document.getElementById('c-name').value;
            const color = document.getElementById('c-color').value;
            if(!name) return;
            if (mode === 'add') state.categories.push({ id: Date.now().toString(), name, color });
            else state.categories = state.categories.map(c => c.id === id ? {...c, name, color} : c);
            closeModal(); render();
        };

        const deleteCat = (id) => {
            if(state.categories.length > 1) {
                state.categories = state.categories.filter(c => c.id !== id);
                state.events = state.events.filter(e => e.type !== id);
                closeModal(); render();
            }
        };

        const closeModal = () => document.getElementById('modal-container').innerHTML = '';
        window.onload = render;
    </script>
</body>
</html>
