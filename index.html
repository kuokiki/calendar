<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>個人化互動行事曆 - 穩定修正版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F9FBFD; -webkit-tap-highlight-color: transparent; }
        .day-cell { min-height: 110px; transition: all 0.2s; cursor: pointer; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        .day-cell:hover { background-color: #f8fafc; }
        .animate-in { animation: fadeIn 0.25s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        input[type="date"], input[type="time"] { background-color: #F3F4F6; border: none; padding: 10px; border-radius: 12px; font-weight: bold; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32 relative">

    <header id="header" class="p-6 bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-100"></header>
    <main id="app-content" class="p-5"></main>
    <div id="bottom-bar" class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[360px] bg-slate-900 shadow-2xl text-white p-3 rounded-[40px] flex justify-between items-center z-50"></div>
    <div id="modal-container"></div>

    <script>
        // --- 初始化狀態 ---
        let state = {
            currentDate: new Date(),
            view: 'month',
            categories: JSON.parse(localStorage.getItem('my_cats')) || [
                { id: 'work', name: '工作項目', color: '#3B82F6', lightColor: '#EFF6FF' },
                { id: 'draw', name: '畫畫創作', color: '#EC4899', lightColor: '#FDF2F8' },
                { id: 'life', name: '生活日常', color: '#10B981', lightColor: '#F0FDF4' }
            ],
            visibleLayers: JSON.parse(localStorage.getItem('my_layers')) || ['work', 'draw', 'life'],
            events: JSON.parse(localStorage.getItem('my_events')) || [],
            showPicker: false,
            isModalOpen: false,
            modalMode: 'add',
            formEvent: {},
            selectedDetail: null,
            isCategoryModalOpen: false
        };

        function saveToStorage() {
            localStorage.setItem('my_cats', JSON.stringify(state.categories));
            localStorage.setItem('my_events', JSON.stringify(state.events));
            localStorage.setItem('my_layers', JSON.stringify(state.visibleLayers));
        }

        const formatDate = (d) => {
            const date = new Date(d);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        const getEventsForDate = (date) => {
            const dStr = formatDate(date);
            const dayIdx = date.getDay();
            return state.events.filter(ev => {
                if (!state.visibleLayers.includes(ev.type)) return false;
                if (ev.isRecurring) {
                    const start = new Date(ev.startDate || ev.date);
                    if (new Date(dStr) < start) return false;
                    if (ev.hasEndDate && ev.endDate && new Date(dStr) > new Date(ev.endDate)) return false;
                    return ev.repeatDays.includes(dayIdx);
                }
                return ev.date === dStr;
            }).sort((a, b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
        };

        // --- 核心渲染 ---
        function update() {
            renderHeader();
            renderContent();
            renderBottomBar();
            renderModal();
            saveToStorage();
            if (window.lucide) lucide.createIcons();
        }

        function renderHeader() {
            const h = document.getElementById('header');
            const d = state.currentDate;
            h.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-xl font-black text-slate-800 flex items-center gap-2 cursor-pointer" onclick="state.showPicker = !state.showPicker; update();">
                        ${d.getFullYear()}年 ${d.getMonth()+1}月 <i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i>
                    </h1>
                    <div class="flex bg-gray-100 p-1 rounded-xl">
                        ${['month', 'day', 'items'].map(v => `
                            <button onclick="state.view='${v}'; update();" class="p-2 rounded-lg ${state.view===v?'bg-white shadow text-blue-600':'text-gray-400'}">
                                <i data-lucide="${v==='month'?'calendar':v==='day'?'calendar-days':'layers'}" class="w-4 h-4"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-2 bg-gray-50 rounded-lg"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <button onclick="state.currentDate=new Date(); update();" class="px-4 text-[10px] font-black bg-gray-50 rounded-lg">今天</button>
                        <button onclick="changeMonth(1)" class="p-2 bg-gray-50 rounded-lg"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex -space-x-2">
                        ${state.categories.map(c => `
                            <button onclick="toggleLayer('${c.id}')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm transition-all ${state.visibleLayers.includes(c.id)?'scale-110 z-10':'opacity-20 grayscale'}" style="background-color:${c.color}"></button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderContent() {
            const main = document.getElementById('app-content');
            if (state.view === 'month') {
                const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
                const first = new Date(y, m, 1).getDay(), num = new Date(y, m + 1, 0).getDate();
                const days = [...Array(first).fill(null), ...Array(num).fill(0).map((_, i) => new Date(y, m, i + 1))];
                
                main.innerHTML = `
                    <div class="grid grid-cols-7 gap-px bg-gray-100 rounded-[24px] overflow-hidden border border-gray-100 animate-in">
                        ${['日','一','二','三','四','五','六'].map(d => `<div class="bg-white p-2 text-center text-[10px] font-black text-gray-300 uppercase">${d}</div>`).join('')}
                        ${days.map(day => {
                            if(!day) return `<div class="bg-gray-50/50"></div>`;
                            const evs = getEventsForDate(day);
                            const isToday = formatDate(day) === formatDate(new Date());
                            return `
                                <div onclick="state.currentDate=new Date('${day}'); state.view='day'; update();" class="day-cell bg-white p-1">
                                    <div class="text-[10px] mb-1 flex justify-center items-center w-5 h-5 mx-auto font-black ${isToday?'bg-blue-600 text-white rounded-full':''}">${day.getDate()}</div>
                                    <div class="space-y-0.5">
                                        ${evs.slice(0, 3).map(e => `<div class="text-[8px] px-1 truncate rounded border font-bold" style="background:${categoriesFind(e.type).lightColor}; border-color:${categoriesFind(e.type).color}">${e.title}</div>`).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (state.view === 'day') {
                const evs = getEventsForDate(state.currentDate);
                main.innerHTML = `
                    <div class="bg-white rounded-[32px] p-8 shadow-sm border border-gray-100 min-h-[400px] animate-in">
                        <h2 class="text-xl font-black mb-8">${formatDate(state.currentDate)} 計畫</h2>
                        <div class="space-y-4">
                            ${evs.map(e => `
                                <div onclick="event.stopPropagation(); state.selectedDetail={event:${JSON.stringify(e).replace(/"/g, '&quot;')}, dateStr:'${formatDate(state.currentDate)}'}; update();" class="flex items-center gap-4 p-4 rounded-2xl border cursor-pointer" style="border-left: 4px solid ${categoriesFind(e.type).color}; background:${categoriesFind(e.type).lightColor}">
                                    <div class="text-[10px] font-black text-slate-400 w-10">${e.hasTime ? e.time : '全天'}</div>
                                    <div class="font-bold text-slate-700">${e.title}</div>
                                </div>
                            `).join('')}
                            ${evs.length === 0 ? '<div class="py-20 text-center opacity-20 font-black">今日無計畫</div>' : ''}
                        </div>
                    </div>
                `;
            } else {
                main.innerHTML = `
                    <div class="space-y-4 animate-in">
                        <button onclick="state.isCategoryModalOpen=true; update();" class="w-full py-4 border-2 border-dashed rounded-3xl text-slate-400 font-black">+ 新增分類</button>
                        ${state.categories.map(c => `
                            <div class="bg-white p-6 rounded-[24px] border border-gray-100 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-4 h-4 rounded-full" style="background:${c.color}"></div>
                                    <span class="font-black text-slate-700">${c.name}</span>
                                </div>
                                <button onclick="state.categories=state.categories.filter(x=>x.id!=='${c.id}'); update();" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function renderBottomBar() {
            document.getElementById('bottom-bar').innerHTML = `
                <div class="pl-6 text-sm font-black text-blue-400">${formatDate(state.currentDate)}</div>
                <button onclick="openAddForm()" class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-all"><i data-lucide="plus" class="text-white"></i></button>
            `;
        }

        function renderModal() {
            const container = document.getElementById('modal-container');
            container.innerHTML = '';
            if (state.isModalOpen) {
                const f = state.formEvent;
                container.innerHTML = `
                    <div class="fixed inset-0 z-[60] flex items-end justify-center modal-backdrop">
                        <div class="bg-white w-full max-w-md rounded-t-[40px] p-8 animate-in">
                            <div class="flex justify-between mb-6">
                                <h2 class="text-xl font-black">規劃行程</h2>
                                <button onclick="state.isModalOpen=false; update();"><i data-lucide="x" class="text-slate-300"></i></button>
                            </div>
                            <div class="space-y-4">
                                <input id="f-title" type="text" placeholder="計畫標題" value="${f.title||''}" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-blue-500">
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="f-date" type="date" value="${f.date}">
                                    <input id="f-time" type="time" value="${f.time||'12:00'}" ${!f.hasTime?'disabled opacity-20':''}>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                    <span class="text-xs font-bold">啟用具體時間</span>
                                    <input type="checkbox" ${f.hasTime?'checked':''} onchange="state.formEvent.hasTime=this.checked; state.formEvent.title=document.getElementById('f-title').value; update();">
                                </div>
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                    <span class="text-xs font-bold">每週重複</span>
                                    <input type="checkbox" ${f.isRecurring?'checked':''} onchange="state.formEvent.isRecurring=this.checked; state.formEvent.title=document.getElementById('f-title').value; update();">
                                </div>
                                ${f.isRecurring ? `<div class="flex justify-between">${['日','一','二','三','四','五','六'].map((d,i)=>`<button onclick="toggleRepeatDay(${i})" class="w-8 h-8 rounded-lg text-[10px] font-bold ${f.repeatDays.includes(i)?'bg-blue-600 text-white':'bg-slate-200'}">${d}</button>`).join('')}</div>` : ''}
                                <div class="grid grid-cols-2 gap-2">
                                    ${state.categories.map(c => `<button onclick="state.formEvent.type='${c.id}'; update();" class="p-3 rounded-xl border-2 text-[10px] font-bold ${f.type===c.id?'border-slate-800 bg-slate-800 text-white':'border-slate-50'}">${c.name}</button>`).join('')}
                                </div>
                                <button onclick="saveEvent()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black">儲存計畫</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (state.selectedDetail) {
                const e = state.selectedDetail.event;
                container.innerHTML = `
                    <div class="fixed inset-0 z-[60] flex items-center justify-center p-6 modal-backdrop animate-in">
                        <div class="bg-white w-full max-w-xs rounded-[32px] overflow-hidden">
                            <div class="h-20 p-6 flex items-end text-white font-black" style="background:${categoriesFind(e.type).color}">
                                ${e.title}
                            </div>
                            <div class="p-6 space-y-4">
                                <div class="text-xs font-bold text-slate-500">${state.selectedDetail.dateStr} ${e.hasTime?e.time:''}</div>
                                <button onclick="state.events=state.events.filter(x=>x.id!=='${e.id}'); state.selectedDetail=null; update();" class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold">刪除行程</button>
                                <button onclick="state.selectedDetail=null; update();" class="w-full text-slate-300 font-bold">關閉</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (state.isCategoryModalOpen) {
                container.innerHTML = `
                    <div class="fixed inset-0 z-[70] flex items-center justify-center p-6 modal-backdrop">
                        <div class="bg-white w-full max-w-xs rounded-[32px] p-8">
                            <h3 class="font-black mb-4">新增分類</h3>
                            <input id="cat-n" type="text" placeholder="名稱" class="w-full p-3 bg-slate-50 rounded-xl mb-4 font-bold">
                            <input id="cat-c" type="color" value="#3B82F6" class="w-full h-10 mb-6 bg-transparent">
                            <button onclick="addCategory()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-black">儲存</button>
                        </div>
                    </div>
                `;
            }
        }

        // --- 功能控制 ---
        function changeMonth(delta) { state.currentDate.setMonth(state.currentDate.getMonth() + delta); update(); }
        function toggleLayer(id) {
            if(state.visibleLayers.includes(id)) state.visibleLayers = state.visibleLayers.filter(i => i !== id);
            else state.visibleLayers.push(id);
            update();
        }
        function openAddForm() {
            state.formEvent = { id:null, title:'', type:state.categories[0].id, date:formatDate(state.currentDate), hasTime:false, time:'12:00', isRecurring:false, repeatDays:[] };
            state.isModalOpen = true;
            update();
        }
        function toggleRepeatDay(i) {
            let days = state.formEvent.repeatDays;
            state.formEvent.repeatDays = days.includes(i) ? days.filter(x => x !== i) : [...days, i];
            update();
        }
        function saveEvent() {
            const title = document.getElementById('f-title').value;
            if(!title) return;
            const newEv = {
                ...state.formEvent,
                id: Date.now().toString(),
                title: title,
                date: document.getElementById('f-date').value,
                time: document.getElementById('f-time').value
            };
            state.events.push(newEv);
            state.isModalOpen = false;
            update();
        }
        function addCategory() {
            const name = document.getElementById('cat-n').value;
            const color = document.getElementById('cat-c').value;
            if(!name) return;
            state.categories.push({ id: Date.now().toString(), name, color, lightColor: color + '20' });
            state.isCategoryModalOpen = false;
            update();
        }
        function categoriesFind(id) { return state.categories.find(c => c.id === id) || { color: '#ccc', lightColor: '#eee' }; }

        window.onload = update;
    </script>
</body>
</html>
