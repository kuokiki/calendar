<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>個人化行事曆 - 精緻版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --accent-blue: #A3C4F3; --text-dark: #1E293B; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F9FBFD; color: var(--text-dark); -webkit-tap-highlight-color: transparent; }
        
        /* 1. 說明欄優化：增加左側內距，解決文字太靠左的問題 */
        input[type="date"], input[type="time"], input[type="text"], textarea { 
            background-color: #F1F5F9; border: none; border-radius: 16px; padding: 14px 20px; width: 100%; outline: none; font-weight: 500; 
            line-height: 1.6; display: block;
        }
        textarea { min-height: 120px; }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 4. 垃圾桶修正：確保圖標置中 */
        .btn-icon-center { display: flex; align-items: center; justify-content: center; }
        
        .day-cell { min-height: 105px; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-32 relative shadow-2xl bg-white">

    <header id="app-header" class="p-6 bg-white/90 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-100"></header>
    <main id="app-main" class="p-5"></main>
    <div id="app-footer" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-[360px] bg-slate-900 shadow-2xl text-white p-3 rounded-[32px] flex justify-between items-center z-50"></div>
    <div id="modal-container"></div>

    <script>
        const SVG = {
            calendar: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
            days: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 2v4M16 2v4M3 10h18M21 4H3v16h18V4z"/></svg>',
            layers: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m12.83 2.18-9.07 4.32a2 2 0 0 0 0 3.38L12.83 14a2 2 0 0 0 1.66 0l9.07-4.32a2 2 0 0 0 0-3.38L13.66 2.18a2 2 0 0 0-1.66 0z"/><path d="m2.1 14.74 9.07 4.32a2 2 0 0 0 1.66 0l9.07-4.32"/><path d="m2.1 10.58 9.07 4.32a2 2 0 0 0 1.66 0l9.07-4.32"/></svg>',
            plus: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5v14"/></svg>',
            x: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>',
            trash: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/></svg>',
            edit: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            chevronDown: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>'
        };

        let state = {
            currentDate: new Date(),
            view: 'month',
            categories: JSON.parse(localStorage.getItem('cats')) || [
                { id: 'c1', name: '工作項目', color: '#A3C4F3' },
                { id: 'c2', name: '畫畫創作', color: '#EC4899' },
                { id: 'c3', name: '生活日常', color: '#CFEFDF' }
            ],
            events: JSON.parse(localStorage.getItem('evs')) || [],
            showDatePicker: false
        };

        const save = () => {
            localStorage.setItem('cats', JSON.stringify(state.categories));
            localStorage.setItem('evs', JSON.stringify(state.events));
        };

        const render = () => {
            renderHeader();
            renderMain();
            renderFooter();
            save();
        };

        // 2 & 3. 年月挑選且同一排
        const renderHeader = () => {
            const d = state.currentDate;
            const months = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
            
            document.getElementById('app-header').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="relative">
                        <button onclick="state.showDatePicker = !state.showDatePicker; render();" class="flex items-center gap-2 text-2xl font-black text-slate-800">
                            ${d.getFullYear()}年 ${months[d.getMonth()]}
                            <span class="text-slate-300">${SVG.chevronDown}</span>
                        </button>
                        
                        ${state.showDatePicker ? `
                        <div class="absolute top-12 left-0 w-64 bg-white shadow-2xl rounded-3xl p-4 z-50 animate-in border border-slate-100">
                            <div class="flex items-center justify-between mb-4 px-2">
                                <button onclick="changeYear(-1)" class="text-slate-400 font-bold">◀</button>
                                <span class="font-black text-lg">${d.getFullYear()}</span>
                                <button onclick="changeYear(1)" class="text-slate-400 font-bold">▶</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                ${months.map((m, i) => `
                                    <button onclick="setMonth(${i})" class="py-2 text-sm font-bold rounded-xl ${d.getMonth() === i ? 'bg-blue-600 text-white' : 'hover:bg-slate-50 text-slate-500'}">
                                        ${m}
                                    </button>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                    
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setView('month')" class="p-2.5 rounded-xl ${state.view==='month'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.calendar}</button>
                        <button onclick="setView('day')" class="p-2.5 rounded-xl ${state.view==='day'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.days}</button>
                        <button onclick="setView('items')" class="p-2.5 rounded-xl ${state.view==='items'?'bg-white shadow text-blue-600':'text-slate-400'}">${SVG.layers}</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="navigate(-1)" class="p-2 bg-slate-50 rounded-xl text-slate-400">◀</button>
                    <button onclick="state.currentDate=new Date(); render();" class="px-4 py-2 bg-slate-50 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-500">TODAY</button>
                    <button onclick="navigate(1)" class="p-2 bg-slate-50 rounded-xl text-slate-400">▶</button>
                </div>
            `;
        };

        const changeYear = (dir) => { state.currentDate.setFullYear(state.currentDate.getFullYear() + dir); render(); };
        const setMonth = (m) => { state.currentDate.setMonth(m); state.showDatePicker = false; render(); };
        const setView = (v) => { state.view = v; render(); };
        const navigate = (dir) => {
            if (state.view === 'day') state.currentDate.setDate(state.currentDate.getDate() + dir);
            else state.currentDate.setMonth(state.currentDate.getMonth() + dir);
            render();
        };

        const renderMain = () => {
            const main = document.getElementById('app-main');
            const fmtDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const findCat = (id) => state.categories.find(c=>c.id===id) || state.categories[0];

            if (state.view === 'month') {
                const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
                const first = new Date(y, m, 1).getDay(), num = new Date(y, m+1, 0).getDate();
                const days = [...Array(first).fill(null), ...Array(num).fill(0).map((_,i)=>new Date(y,m,i+1))];
                main.innerHTML = `
                    <div class="grid grid-cols-7 gap-px bg-slate-100 rounded-[24px] overflow-hidden border border-slate-50 animate-in">
                        ${['日','一','二','三','四','五','六'].map(d=>`<div class="bg-white p-3 text-center text-[10px] font-bold text-slate-300">${d}</div>`).join('')}
                        ${days.map(day => {
                            if(!day) return `<div class="bg-slate-50/50 min-h-[95px]"></div>`;
                            const dStr = fmtDate(day);
                            const evs = state.events.filter(e => e.date === dStr);
                            const isToday = dStr === fmtDate(new Date());
                            return `
                                <div onclick="state.currentDate=new Date('${day}'); state.view='day'; render();" class="day-cell bg-white p-1">
                                    <div class="text-[10px] mb-1 flex justify-center items-center w-6 h-6 mx-auto font-black ${isToday?'bg-blue-600 text-white rounded-full':''}">${day.getDate()}</div>
                                    <div class="space-y-0.5">${evs.slice(0,3).map(e=>`<div class="text-[8px] px-1 truncate rounded border font-bold" style="background:${findCat(e.type).color}25; border-color:${findCat(e.type).color}">${e.title}</div>`).join('')}</div>
                                </div>`;
                        }).join('')}
                    </div>`;
            } else if (state.view === 'day') {
                const dStr = fmtDate(state.currentDate);
                const evs = state.events.filter(e => e.date === dStr);
                main.innerHTML = `
                    <div class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-50 min-h-[400px] animate-in">
                        <h2 class="text-xl font-black mb-6">${dStr}</h2>
                        <div class="space-y-4">
                            ${evs.map(e => `
                                <div onclick="openEventForm('edit', '${e.id}')" class="p-5 rounded-3xl border flex justify-between items-center cursor-pointer" style="border-left:5px solid ${findCat(e.type).color}; background:${findCat(e.type).color}10">
                                    <div class="flex-1">
                                        <div class="text-[10px] font-black opacity-40 uppercase tracking-widest">${e.hasTime?e.time:'全天'}</div>
                                        <div class="font-bold text-slate-700">${e.title}</div>
                                        ${e.desc ? `<div class="text-[11px] text-slate-400 mt-2 line-clamp-2">${e.desc}</div>` : ''}
                                    </div>
                                    <span class="text-slate-300 ml-4">▶</span>
                                </div>`).join('')}
                            ${evs.length===0?'<div class="py-24 text-center opacity-20 font-black">今日無計畫</div>':''}
                        </div>
                    </div>`;
            } else {
                main.innerHTML = `
                    <div class="space-y-4 animate-in">
                        <button onclick="openCatModal()" class="w-full py-5 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-black">+ 新增項目分類</button>
                        ${state.categories.map(c => `
                            <div class="bg-white p-6 rounded-3xl border border-slate-50 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-4">
                                    <div class="w-4 h-4 rounded-full" style="background:${c.color}"></div>
                                    <span class="font-black text-slate-700">${c.name}</span>
                                </div>
                                <button onclick="state.categories=state.categories.filter(x=>x.id!=='${c.id}'); render();" class="text-slate-200">${SVG.trash}</button>
                            </div>`).join('')}
                    </div>`;
            }
        };

        const renderFooter = () => {
            const fmtDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            document.getElementById('app-footer').innerHTML = `
                <div class="pl-6 text-sm font-black text-blue-400">${fmtDate(state.currentDate)}</div>
                <button onclick="openEventForm('add')" class="bg-blue-600 w-14 h-14 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-all text-white">${SVG.plus}</button>
            `;
        };

        // 4. 垃圾桶與彈窗修正
        const openEventForm = (mode, id = null) => {
            const fmtDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            let ev = mode === 'add' ? { id:Date.now().toString(), title:'', desc:'', type:state.categories[0].id, date:fmtDate(state.currentDate), hasTime:false, time:'12:00' } : {...state.events.find(e=>e.id===id)};
            
            document.getElementById('modal-container').innerHTML = `
                <div class="fixed inset-0 z-[60] flex items-end justify-center modal-overlay">
                    <div class="bg-white w-full max-w-md rounded-t-[40px] p-8 animate-in overflow-y-auto max-h-[90vh]">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black">計畫詳情</h2>
                            <button onclick="closeModal()">${SVG.x}</button>
                        </div>
                        <div class="space-y-5">
                            <input id="f-title" type="text" placeholder="計畫標題" value="${ev.title}">
                            <textarea id="f-desc" placeholder="說明欄 (自由選填)">${ev.desc || ''}</textarea>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-black text-slate-300 block mb-1 uppercase">日期</label><input id="f-date" type="date" value="${ev.date}"></div>
                                <div id="time-box" style="${ev.hasTime?'':'display:none'}"><label class="text-[10px] font-black text-slate-300 block mb-1 uppercase">時間</label><input id="f-time" type="time" value="${ev.time}"></div>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <span class="font-black text-xs text-slate-500 uppercase tracking-widest">具體時間</span>
                                <input type="checkbox" id="f-hasTime" ${ev.hasTime?'checked':''} onchange="document.getElementById('time-box').style.display=this.checked?'block':'none'">
                            </div>

                            <div class="grid grid-cols-3 gap-2">
                                ${state.categories.map(c=>`<button onclick="window.selectedCat='${c.id}'; this.parentElement.querySelectorAll('button').forEach(b=>b.className='p-2 rounded-xl border-2 text-[10px] font-bold border-slate-50 text-slate-400'); this.className='p-2 rounded-xl border-2 text-[10px] font-bold border-slate-800 bg-slate-800 text-white'" class="p-2 rounded-xl border-2 text-[10px] font-bold ${ev.type===c.id?'border-slate-800 bg-slate-800 text-white':'border-slate-50 text-slate-400'}">${c.name}</button>`).join('')}
                            </div>

                            <div class="flex gap-3">
                                <button onclick="saveEvent('${ev.id}')" class="flex-[3] py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">儲存</button>
                                ${mode==='edit' ? `<button onclick="deleteEvent('${ev.id}')" class="flex-1 bg-red-50 text-red-500 rounded-2xl btn-icon-center transition-colors hover:bg-red-100">${SVG.trash}</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            window.selectedCat = ev.type;
        };

        const saveEvent = (id) => {
            const title = document.getElementById('f-title').value;
            if(!title) return alert('請輸入標題');
            const data = {
                id,
                title,
                desc: document.getElementById('f-desc').value,
                date: document.getElementById('f-date').value,
                hasTime: document.getElementById('f-hasTime').checked,
                time: document.getElementById('f-time').value,
                type: window.selectedCat
            };
            state.events = [...state.events.filter(e=>e.id!==id), data];
            closeModal(); render();
        };

        const deleteEvent = (id) => { state.events = state.events.filter(e=>e.id!==id); closeModal(); render(); };
        const openCatModal = () => { /* ...原本的新增類別邏輯... */ };
        const closeModal = () => document.getElementById('modal-container').innerHTML = '';
        window.onload = render;
    </script>
</body>
</html>
